# üîí –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò

### 1. **Firestore Security Rules** üõ°Ô∏è
- **–ü—Ä–æ–±–ª–µ–º–∞**: –õ—é–±–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —á–∏—Ç–∞—Ç—å/–∏–∑–º–µ–Ω—è—Ç—å —á—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
- **–†–µ—à–µ–Ω–∏–µ**: 
  - –°–æ–∑–¥–∞–Ω `firestore-secure.rules` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä–æ–π
  - –î–æ–±–∞–≤–ª–µ–Ω—ã helper —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
  - –ù–∞–ø–∏—Å–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–∞–≤–∏–ª (`firestore-rules.test.js`)
- **–§–∞–π–ª—ã**: 
  - `firestore-secure.rules`
  - `firestore-rules.test.js`
  - `firestore-test-setup.md`

### 2. **Storage Security Rules** üìÅ
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤, –∑–∞–ø–∏—Å—å –¥–ª—è –ª—é–±–æ–≥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω `storage-secure.rules` —Å –ø—Ä–∏–≤—è–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤ –∫ userId
  - –û–≥—Ä–∞–Ω–∏—á–µ–Ω—ã —Ç–∏–ø—ã –∏ —Ä–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º
- **–§–∞–π–ª—ã**:
  - `storage-secure.rules`
  - `docs/STORAGE_MIGRATION_GUIDE.md`

### 3. **Cloud Functions Authentication** ‚òÅÔ∏è
- **–ü—Ä–æ–±–ª–µ–º–∞**: HTTP —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, CORS *
- **–†–µ—à–µ–Ω–∏–µ**:
  - –ó–∞–º–µ–Ω–µ–Ω—ã `onRequest` –Ω–∞ `onCall` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π auth
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π (isAdmin, canAccessUserData)
  - –û–≥—Ä–∞–Ω–∏—á–µ–Ω CORS —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–§–∞–π–ª—ã**:
  - `functions/index-secure.js`
  - `docs/CLOUD_FUNCTIONS_MIGRATION.md`

### 4. **Tuya Secrets Removal** üè†
- **–ü—Ä–æ–±–ª–µ–º–∞**: Client ID/Secret –∏ HMAC –ø–æ–¥–ø–∏—Å—å –≤ –∫–ª–∏–µ–Ω—Ç–µ
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏ `functions/tuya-proxy.js`
  - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç `lib/core/services/tuya_cloud_service_secure.dart`
  - –°–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ Firebase Functions Config
- **–§–∞–π–ª—ã**:
  - `functions/tuya-proxy.js`
  - `lib/core/services/tuya_cloud_service_secure.dart`
  - `docs/TUYA_MIGRATION_GUIDE.md`

### 5. **Payment Security (Payme)** üí≥
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–±–æ—Ä PAN/CVV –≤ –∫–ª–∏–µ–Ω—Ç–µ, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Payme (`functions/payment-service.js`)
  - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –±–µ–∑ —Å–±–æ—Ä–∞ –∫–∞—Ä—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  - Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback –æ—Ç Payme
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **–§–∞–π–ª—ã**:
  - `functions/payment-service.js`
  - `lib/core/services/payment_service_secure.dart`
  - `lib/presentation/payment_screen/payment_screen_secure.dart`
  - `docs/PAYMENT_SECURITY_GUIDE.md`

### 6. **PII Logging Prevention** üìù
- **–ü—Ä–æ–±–ª–µ–º–∞**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –ø–∞—Å–ø–æ—Ä—Ç–æ–≤, —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ print()
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω `LoggingService` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π PII
  - –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã print() statements
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Crashlytics –±–µ–∑ PII
- **–§–∞–π–ª—ã**:
  - `lib/core/services/logging_service_secure.dart`
  - `scripts/replace_print_statements.dart`
  - `docs/SECURE_LOGGING_GUIDE.md`

### 7. **iOS ATS Configuration** üì±
- **–ü—Ä–æ–±–ª–µ–º–∞**: NSAllowsArbitraryLoads = true —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ª—é–±—ã–µ HTTP
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–π `Info-Secure.plist`
  - –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ HTTP –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - –ò—Å–∫–ª—é—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è localhost/dev
- **–§–∞–π–ª—ã**:
  - `ios/Runner/Info-Secure.plist`
  - `scripts/check_http_usage.dart`
  - `docs/IOS_ATS_SECURITY_GUIDE.md`

### 8. **Flutter Lifecycle Safety** üîÑ
- **–ü—Ä–æ–±–ª–µ–º–∞**: setState –ø–æ—Å–ª–µ await –±–µ–∑ mounted, —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω `SafeStateMixin` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  - –°–∫—Ä–∏–ø—Ç –ø–æ–∏—Å–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
  - –ü—Ä–∏–º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–§–∞–π–ª—ã**:
  - `lib/core/mixins/safe_state_mixin.dart`
  - `lib/widgets/safe_stateful_widget_example.dart`
  - `scripts/fix_setstate_issues.dart`
  - `docs/FLUTTER_LIFECYCLE_SAFETY_GUIDE.md`

### 9. **Offline Queue Idempotency** üîÑ
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω `OfflineQueueService` —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
  - –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –¥–ª—è —Ä–µ—Ç—Ä–∞–µ–≤
  - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SecureStorage
  - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ
- **–§–∞–π–ª—ã**:
  - `lib/core/services/offline_queue_service.dart`
  - `lib/core/services/service_request_service_with_offline.dart`
  - `docs/OFFLINE_QUEUE_GUIDE.md`

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- **Security Rules**: 4 —Ñ–∞–π–ª–∞
- **Cloud Functions**: 3 —Ñ–∞–π–ª–∞  
- **Dart Services**: 5 —Ñ–∞–π–ª–æ–≤
- **Mixins/Utils**: 3 —Ñ–∞–π–ª–∞
- **Scripts**: 3 —Ñ–∞–π–ª–∞
- **Documentation**: 9 —Ñ–∞–π–ª–æ–≤
- **Examples**: 2 —Ñ–∞–π–ª–∞

**–í—Å–µ–≥–æ**: 29 –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- ‚úÖ Zero Trust –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è Firestore/Storage
- ‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- ‚úÖ PII –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è
- ‚úÖ –ü–ª–∞—Ç–µ–∂–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π gateway
- ‚úÖ Lifecycle –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ mixins
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üöÄ –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –¥–Ω—è)
1. –î–µ–ø–ª–æ–π –Ω–æ–≤—ã—Ö Firestore Rules
2. –î–µ–ø–ª–æ–π –Ω–æ–≤—ã—Ö Storage Rules
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Cloud Functions —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
4. –ó–∞–º–µ–Ω–∞ Info.plist –¥–ª—è iOS

### –§–∞–∑–∞ 2: –ú–∏–≥—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ (3-5 –¥–Ω–µ–π)
1. –ú–∏–≥—Ä–∞—Ü–∏—è Tuya –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏
2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Payme —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
3. –ó–∞–º–µ–Ω–∞ LoggingService
4. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ OfflineQueueService

### –§–∞–∑–∞ 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ UI (1 –Ω–µ–¥–µ–ª—è)
1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SafeStateMixin
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ –æ–ø–ª–∞—Ç—ã
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ offline –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:
1. **Backup –¥–∞–Ω–Ω—ã—Ö** - —Å–¥–µ–ª–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π backup Firestore
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª** - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–∞–≤–∏–ª
3. **–°–º–µ–Ω–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤** - —Å–º–µ–Ω–∏—Ç–µ –≤—Å–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ 403/401 –≤ –ø–µ—Ä–≤—ã–µ —á–∞—Å—ã
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã offline –æ—á–µ—Ä–µ–¥–∏
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –Ω–∞ —É—Ç–µ—á–∫–∏ PII

## üìã CHECKLIST –î–õ–Ø CODE REVIEW

- [ ] –í—Å–µ print() –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ LoggingService
- [ ] –ù–µ—Ç –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ setState –ø–æ—Å–ª–µ await
- [ ] –í—Å–µ StreamSubscription –æ—Ç–ø–∏—Å–∞–Ω—ã
- [ ] –í—Å–µ Timer –æ—Ç–º–µ–Ω–µ–Ω—ã
- [ ] –ù–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ
- [ ] Firestore –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤–ª–∞–¥–µ–Ω–∏–µ
- [ ] Storage –ø—Ä–∞–≤–∏–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –¥–æ—Å—Ç—É–ø
- [ ] Cloud Functions —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- [ ] iOS ATS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Offline –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **OWASP Mobile Top 10** - —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- **PCI DSS** - –ø–ª–∞—Ç–µ–∂–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- **GDPR** - PII –∑–∞—â–∏—â–µ–Ω—ã –∏ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- **Zero Trust** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ

–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏–π security –∞—É–¥–∏—Ç –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.
