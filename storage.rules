rules_version = '2';

// üîê –ë–ï–ó–û–ü–ê–°–ù–´–ï –ü–†–ê–í–ò–õ–ê FIREBASE STORAGE –î–õ–Ø –ü–†–û–î–ê–ö–®–ù–ê
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç signInAnonymously)
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isAuthenticated() {
      // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö)
      return request.auth != null;
    }
    
    function isValidImage() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä –º–µ–Ω—å—à–µ 10MB (—É–≤–µ–ª–∏—á–µ–Ω–æ —Å 5MB)
      return request.resource != null &&
             request.resource.contentType != null &&
             request.resource.contentType.matches('image/.*') &&
             request.resource.size < 10 * 1024 * 1024; // 10MB –≤–º–µ—Å—Ç–æ 5MB
    }
    
    function isValidFileSize() {
      // –û–±—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–¥–æ 15MB)
      return request.resource != null &&
             request.resource.size < 15 * 1024 * 1024; // 15MB
    }
    
    // üì± SERVICE REQUEST IMAGES - –ë–û–õ–ï–ï –ú–Ø–ì–ö–ò–ï –ü–†–ê–í–ò–õ–ê
    // –ü—É—Ç—å: service_requests/{requestId}/images/{imageId}
    match /service_requests/{requestId}/images/{imageId} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ
      allow read: if true;
      // –ó–∞–ø–∏—Å—å –¥–ª—è –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö)
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üë§ USER PROFILE IMAGES
    // –ü—É—Ç—å: users/{userId}/profile/{imageId}
    match /users/{userId}/profile/{imageId} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
      allow read: if true;
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üìä UTILITY READING IMAGES
    // –ü—É—Ç—å: utility_readings/{readingId}/images/{imageId}
    match /utility_readings/{readingId}/images/{imageId} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
      allow read: if true;
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üì∞ NEWS AND ADMIN CONTENT
    // –ü—É—Ç—å: admin/{allPaths=**}
    match /admin/{allPaths=**} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      allow read: if true;
      // –ó–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      allow write, delete: if isAuthenticated() && isValidFileSize();
    }
    
    // üìÅ TEMPORARY UPLOADS - –ë–û–õ–ï–ï –ú–Ø–ì–ö–ò–ï –ü–†–ê–í–ò–õ–ê
    // –ü—É—Ç—å: temp/{userId}/{fileName}
    match /temp/{userId}/{fileName} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      allow read: if true;
      // –ó–∞–ø–∏—Å—å –¥–ª—è –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üõ†Ô∏è –û–¢–õ–ê–î–ö–ê - –í–†–ï–ú–ï–ù–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –í–°–ï–• –ü–£–¢–ï–ô
    // –ü–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å –ª—é–±—ã–µ —Ñ–∞–π–ª—ã (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ)
    match /{allPaths=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
  }
} 