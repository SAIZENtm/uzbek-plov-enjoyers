<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Newport</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #2196F3;
        }
        
        .section h2 {
            color: #2196F3;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .btn {
            background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            color: #0c5460;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: border-color 0.3s;
        }
        
        .card:hover {
            border-color: #2196F3;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .console-line {
            margin-bottom: 5px;
        }
        
        .console-line.error {
            color: #ff6b6b;
        }
        
        .console-line.warning {
            color: #ffa500;
        }
        
        .console-line.success {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Newport</h1>
            <p>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('diagnosis')">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
                <button class="tab" onclick="switchTab('create')">–°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
                <button class="tab" onclick="switchTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="tab" onclick="switchTab('fcm')">FCM Debug</button>
            </div>
            
            <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
            <div id="diagnosis" class="tab-content active">
                <div class="section">
                    <h2>üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
                    <div class="form-group">
                        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</label>
                        <input type="text" id="diagnosticUserId" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω">
                    </div>
                    <button class="btn" onclick="runFullDiagnostic()">
                        <span id="diagnosticLoader"></span>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                    </button>
                    <div id="diagnosticResult" class="result"></div>
                </div>
            </div>
            
            <!-- –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div id="create" class="tab-content">
                <div class="section">
                    <h2>‚úâÔ∏è –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
                    <div class="form-group">
                        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" id="createUserId" placeholder="–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞">
                    </div>
                    <div class="form-group">
                        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                        <input type="text" id="createTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                    </div>
                    <div class="form-group">
                        <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                        <textarea id="createMessage" placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"></textarea>
                    </div>
                    <div class="form-group">
                        <label>–¢–∏–ø:</label>
                        <select id="createType">
                            <option value="admin_response">–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</option>
                            <option value="system">–°–∏—Å—Ç–µ–º–Ω–æ–µ</option>
                            <option value="service_update">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏</option>
                            <option value="news">–ù–æ–≤–æ—Å—Ç—å</option>
                        </select>
                    </div>
                    <button class="btn success" onclick="createTestNotification()">
                        <span id="createLoader"></span>
                        –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    </button>
                    <div id="createResult" class="result"></div>
                </div>
            </div>
            
            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            <div id="users" class="tab-content">
                <div class="section">
                    <h2>üë• –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                    <button class="btn" onclick="analyzeUsers()">
                        <span id="usersLoader"></span>
                        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    </button>
                    <div id="usersResult" class="result"></div>
                </div>
            </div>
            
            <!-- FCM Debug -->
            <div id="fcm" class="tab-content">
                <div class="section">
                    <h2>üîî FCM –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
                    <div class="form-group">
                        <label>FCM Token:</label>
                        <textarea id="fcmToken" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ FCM —Ç–æ–∫–µ–Ω"></textarea>
                    </div>
                    <div class="form-group">
                        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                        <input type="text" id="fcmTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ push">
                    </div>
                    <div class="form-group">
                        <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                        <textarea id="fcmMessage" placeholder="–¢–µ–∫—Å—Ç push —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
                    </div>
                    <button class="btn" onclick="testFCMPush()">
                        <span id="fcmLoader"></span>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π push
                    </button>
                    <div id="fcmResult" class="result"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBaZ2_2FbDOXjdFN_hBJFrqDLJwrKJfIo4",
            authDomain: "newport-23a19.firebaseapp.com",
            projectId: "newport-23a19",
            storageBucket: "newport-23a19.appspot.com",
            messagingSenderId: "346693260115",
            appId: "1:346693260115:web:b6b6b6b6b6b6b6b6b6b6b6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.db = db;
        window.functions = functions;
        window.firebase = { doc, setDoc, getDoc, getDocs, query, where, orderBy, limit, collection, httpsCallable };

        // Utility functions
        window.log = function(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const console = document.getElementById('console');
            if (console) {
                const line = document.createElement('div');
                line.className = `console-line ${type}`;
                line.textContent = `[${timestamp}] ${message}`;
                console.appendChild(line);
                console.scrollTop = console.scrollHeight;
            }
        };

        window.clearLog = function() {
            const console = document.getElementById('console');
            if (console) {
                console.innerHTML = '';
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        window.showResult = function(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = content;
                element.className = `result ${type}`;
                element.style.display = 'block';
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        window.showLoader = function(elementId, show = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = show ? '<div class="loading"></div>' : '';
            }
        };

        console.log('Firebase initialized successfully');
        window.log('Firebase initialized successfully', 'success');
    </script>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        async function runFullDiagnostic() {
            const userId = document.getElementById('diagnosticUserId').value;
            if (!userId) {
                showResult('diagnosticResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            showLoader('diagnosticLoader', true);
            let diagnosticLog = '';

            try {
                diagnosticLog += `=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ===\n`;
                diagnosticLog += `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}\n`;
                diagnosticLog += `–í—Ä–µ–º—è: ${new Date().toLocaleString()}\n\n`;

                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö
                diagnosticLog += `üîç –ü–†–û–í–ï–†–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–ê–ó–ï –î–ê–ù–ù–´–•:\n`;
                
                const userResults = await checkUserInCollections(userId);
                diagnosticLog += userResults.log;
                
                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                diagnosticLog += `\nüì® –ü–†–û–í–ï–†–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô:\n`;
                
                const notificationResults = await checkNotifications(userId);
                diagnosticLog += notificationResults.log;
                
                // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤
                diagnosticLog += `\nüîî –ü–†–û–í–ï–†–ö–ê FCM –¢–û–ö–ï–ù–û–í:\n`;
                
                const fcmResults = await checkFCMTokens(userId);
                diagnosticLog += fcmResults.log;
                
                // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
                diagnosticLog += `\nüîß –ü–†–û–í–ï–†–ö–ê –ó–ê–Ø–í–û–ö –ù–ê –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï:\n`;
                
                const serviceRequestResults = await checkServiceRequests(userId);
                diagnosticLog += serviceRequestResults.log;
                
                // 5. –ò—Ç–æ–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                diagnosticLog += `\nüìä –ò–¢–û–ì–û–í–´–ô –ê–ù–ê–õ–ò–ó:\n`;
                
                const issues = [];
                if (!userResults.found) issues.push('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                if (notificationResults.count === 0) issues.push('–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                if (fcmResults.tokenCount === 0) issues.push('–ù–µ—Ç FCM —Ç–æ–∫–µ–Ω–æ–≤');
                if (serviceRequestResults.count === 0) issues.push('–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ');
                
                if (issues.length === 0) {
                    diagnosticLog += `‚úÖ –ü—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ\n`;
                } else {
                    diagnosticLog += `‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:\n`;
                    issues.forEach(issue => diagnosticLog += `  - ${issue}\n`);
                }
                
                // 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                diagnosticLog += `\nüí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:\n`;
                diagnosticLog += await generateRecommendations(userResults, notificationResults, fcmResults, serviceRequestResults);

                showResult('diagnosticResult', diagnosticLog, 'info');
                
            } catch (error) {
                diagnosticLog += `\n‚ùå –û–®–ò–ë–ö–ê –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò: ${error.message}\n`;
                showResult('diagnosticResult', diagnosticLog, 'error');
            } finally {
                showLoader('diagnosticLoader', false);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö
        async function checkUserInCollections(userId) {
            let log = '';
            let found = false;
            
            const collections = ['users', 'residents', 'clients'];
            const searchFields = ['passport_number', 'passportNumber', 'phone', 'id'];
            
            for (const collectionName of collections) {
                log += `  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "${collectionName}":\n`;
                
                try {
                    // –ü–æ–∏—Å–∫ –ø–æ –ø—Ä—è–º–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
                    const directDoc = await firebase.getDoc(firebase.doc(db, collectionName, userId));
                    if (directDoc.exists()) {
                        log += `    ‚úÖ –ù–∞–π–¥–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ ID: ${userId}\n`;
                        log += `    –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(directDoc.data(), null, 2)}\n`;
                        found = true;
                        continue;
                    }
                    
                    // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—è–º
                    for (const field of searchFields) {
                        const q = firebase.query(
                            firebase.collection(db, collectionName), 
                            firebase.where(field, '==', userId),
                            firebase.limit(5)
                        );
                        const snapshot = await firebase.getDocs(q);
                        
                        if (!snapshot.empty) {
                            log += `    ‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ –ø–æ–ª—é "${field}": ${snapshot.size} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n`;
                            snapshot.forEach(doc => {
                                log += `      ID: ${doc.id}, –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(doc.data(), null, 2)}\n`;
                            });
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found) {
                        log += `    ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "${collectionName}"\n`;
                    }
                    
                } catch (error) {
                    log += `    ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "${collectionName}": ${error.message}\n`;
                }
            }
            
            return { found, log };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        async function checkNotifications(userId) {
            let log = '';
            let count = 0;
            
            try {
                const identifiers = [userId];
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                if (userId.startsWith('+')) {
                    identifiers.push(userId.substring(1));
                } else if (userId.match(/^\d+$/)) {
                    identifiers.push('+' + userId);
                }
                
                log += `  –ü–æ–∏—Å–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤: ${identifiers.join(', ')}\n`;
                
                for (const identifier of identifiers) {
                    const q = firebase.query(
                        firebase.collection(db, 'notifications'),
                        firebase.where('userId', '==', identifier),
                        firebase.orderBy('createdAt', 'desc'),
                        firebase.limit(10)
                    );
                    
                    const snapshot = await firebase.getDocs(q);
                    
                    if (!snapshot.empty) {
                        log += `    ‚úÖ –ù–∞–π–¥–µ–Ω–æ ${snapshot.size} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è "${identifier}"\n`;
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            log += `      - ${data.title} (${data.type}) - ${data.createdAt}\n`;
                            count++;
                        });
                    } else {
                        log += `    ‚ùå –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è "${identifier}"\n`;
                    }
                }
                
            } catch (error) {
                log += `  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${error.message}\n`;
            }
            
            return { count, log };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤
        async function checkFCMTokens(userId) {
            let log = '';
            let tokenCount = 0;
            
            try {
                const collections = ['users', 'residents', 'clients'];
                
                for (const collectionName of collections) {
                    const userDoc = await firebase.getDoc(firebase.doc(db, collectionName, userId));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const fcmTokens = data.fcmTokens || [];
                        
                        if (fcmTokens.length > 0) {
                            log += `  ‚úÖ –ù–∞–π–¥–µ–Ω–æ ${fcmTokens.length} FCM —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "${collectionName}"\n`;
                            fcmTokens.forEach((token, index) => {
                                log += `    ${index + 1}. ${token.substring(0, 20)}...\n`;
                            });
                            tokenCount += fcmTokens.length;
                        } else {
                            log += `  ‚ùå –ù–µ—Ç FCM —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "${collectionName}"\n`;
                        }
                    }
                }
                
            } catch (error) {
                log += `  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ FCM —Ç–æ–∫–µ–Ω–æ–≤: ${error.message}\n`;
            }
            
            return { tokenCount, log };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
        async function checkServiceRequests(userId) {
            let log = '';
            let count = 0;
            
            try {
                const q = firebase.query(
                    firebase.collection(db, 'serviceRequests'),
                    firebase.where('userId', '==', userId),
                    firebase.orderBy('createdAt', 'desc'),
                    firebase.limit(5)
                );
                
                const snapshot = await firebase.getDocs(q);
                
                if (!snapshot.empty) {
                    log += `  ‚úÖ –ù–∞–π–¥–µ–Ω–æ ${snapshot.size} –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n`;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        log += `    - ${data.requestType} (${data.status}) - ${data.createdAt}\n`;
                        count++;
                    });
                } else {
                    log += `  ‚ùå –ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n`;
                }
                
            } catch (error) {
                log += `  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞—è–≤–æ–∫: ${error.message}\n`;
            }
            
            return { count, log };
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        async function generateRecommendations(userResults, notificationResults, fcmResults, serviceRequestResults) {
            let recommendations = '';
            
            if (!userResults.found) {
                recommendations += `1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n`;
                recommendations += `2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞ –ø–∞—Å–ø–æ—Ä—Ç–∞\n`;
            }
            
            if (notificationResults.count === 0) {
                recommendations += `3. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n`;
                recommendations += `4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏\n`;
            }
            
            if (fcmResults.tokenCount === 0) {
                recommendations += `5. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n`;
                recommendations += `6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é FCM –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏\n`;
            }
            
            if (serviceRequestResults.count === 0) {
                recommendations += `7. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n`;
            }
            
            return recommendations || '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è';
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        async function createTestNotification() {
            const userId = document.getElementById('createUserId').value;
            const title = document.getElementById('createTitle').value;
            const message = document.getElementById('createMessage').value;
            const type = document.getElementById('createType').value;
            
            if (!userId || !title || !message) {
                showResult('createResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            showLoader('createLoader', true);
            
            try {
                const notificationId = `test_${Date.now()}`;
                const notification = {
                    id: notificationId,
                    userId: userId,
                    title: title,
                    message: message,
                    type: type,
                    createdAt: new Date().toISOString(),
                    readAt: null,
                    isRead: false,
                    data: {},
                    relatedRequestId: null,
                    adminName: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç',
                    imageUrl: null
                };
                
                await firebase.setDoc(firebase.doc(db, 'notifications', notificationId), notification);
                
                showResult('createResult', `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!\nID: ${notificationId}\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ`, 'success');
                
            } catch (error) {
                showResult('createResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`, 'error');
            } finally {
                showLoader('createLoader', false);
            }
        }

        // –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function analyzeUsers() {
            showLoader('usersLoader', true);
            
            try {
                let analysis = '=== –ê–ù–ê–õ–ò–ó –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ===\n\n';
                
                const collections = ['users', 'residents', 'clients'];
                
                for (const collectionName of collections) {
                    analysis += `üìÅ –ö–æ–ª–ª–µ–∫—Ü–∏—è "${collectionName}":\n`;
                    
                    const snapshot = await firebase.getDocs(firebase.collection(db, collectionName));
                    analysis += `  –í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${snapshot.size}\n`;
                    
                    let withPassport = 0;
                    let withPhone = 0;
                    let withFCM = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.passport_number || data.passportNumber) withPassport++;
                        if (data.phone) withPhone++;
                        if (data.fcmTokens && data.fcmTokens.length > 0) withFCM++;
                    });
                    
                    analysis += `  –° –Ω–æ–º–µ—Ä–æ–º –ø–∞—Å–ø–æ—Ä—Ç–∞: ${withPassport}\n`;
                    analysis += `  –° –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${withPhone}\n`;
                    analysis += `  –° FCM —Ç–æ–∫–µ–Ω–∞–º–∏: ${withFCM}\n\n`;
                }
                
                // –ê–Ω–∞–ª–∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                analysis += `üì® –ê–Ω–∞–ª–∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:\n`;
                const notificationsSnapshot = await firebase.getDocs(firebase.collection(db, 'notifications'));
                analysis += `  –í—Å–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${notificationsSnapshot.size}\n`;
                
                const userIds = new Set();
                const types = {};
                
                notificationsSnapshot.forEach(doc => {
                    const data = doc.data();
                    userIds.add(data.userId);
                    types[data.type] = (types[data.type] || 0) + 1;
                });
                
                analysis += `  –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${userIds.size}\n`;
                analysis += `  –ü–æ —Ç–∏–ø–∞–º:\n`;
                Object.entries(types).forEach(([type, count]) => {
                    analysis += `    ${type}: ${count}\n`;
                });
                
                showResult('usersResult', analysis, 'info');
                
            } catch (error) {
                showResult('usersResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ${error.message}`, 'error');
            } finally {
                showLoader('usersLoader', false);
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FCM push
        async function testFCMPush() {
            const token = document.getElementById('fcmToken').value;
            const title = document.getElementById('fcmTitle').value;
            const message = document.getElementById('fcmMessage').value;
            
            if (!token || !title || !message) {
                showResult('fcmResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            showLoader('fcmLoader', true);
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Cloud Function –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push
                const sendPushNotification = firebase.httpsCallable(functions, 'sendPushNotification');
                
                const result = await sendPushNotification({
                    tokens: [token],
                    notification: {
                        title: title,
                        body: message
                    },
                    data: {
                        type: 'test',
                        source: 'diagnostic_tool'
                    }
                });
                
                showResult('fcmResult', `‚úÖ Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!\n–†–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(result.data, null, 2)}`, 'success');
                
            } catch (error) {
                showResult('fcmResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ push: ${error.message}`, 'error');
            } finally {
                showLoader('fcmLoader', false);
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å console –¥–ª—è –ª–æ–≥–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
            const consoleDiv = document.createElement('div');
            consoleDiv.id = 'console';
            consoleDiv.className = 'console';
            consoleDiv.style.display = 'none';
            document.body.appendChild(consoleDiv);
        });
    </script>
</body>
</html> 