# Структура данных Firestore для Newport Resident App

## Обзор

Приложение использует Firebase Firestore для хранения данных о жилом комплексе Newport. Структура оптимизирована для эффективного поиска квартир по паспорту владельца и поддержки случаев, когда один владелец имеет несколько квартир.

## Коллекции

### 1. blocks (Блоки)
Коллекция верхнего уровня, содержащая информацию о блоках жилого комплекса.

```
/blocks/{blockId}
```

**Поля документа:**
- `name` (string) - Название блока (например, "Блок A")
- `address` (string) - Адрес блока
- `totalFloors` (number) - Общее количество этажей
- `totalApartments` (number) - Общее количество квартир
- `status` (string) - Статус блока ('active', 'construction', etc.)
- `createdAt` (timestamp) - Дата создания записи
- `updatedAt` (timestamp) - Дата последнего обновления

**ID документа:** A, B, C, D, E, F

### 2. apartments (Квартиры)
Подколлекция внутри каждого блока, содержащая информацию о квартирах.

```
/blocks/{blockId}/apartments/{apartmentNumber}
```

**Поля документа:**
- `blockId` (string) - ID блока (A, B, C, D, E, F)
- `apartmentNumber` (string) - Номер квартиры (например, "01-222")
- `floorName` (string) - Этаж
- `netAreaM2` (number) - Чистая площадь в м²
- `grossAreaM2` (number) - Общая площадь в м²
- `ownershipCode` (string) - Код собственности
- `ownerId` (string) - ID владельца (ссылка на документ в коллекции clients)

**Данные владельца (денормализованные для быстрого доступа):**
- `fullName` (string) - ФИО владельца
- `phone` (string) - Телефон владельца
- `passportNumber` (string) - Номер паспорта владельца
- `clientAddress` (string) - Адрес владельца

**Данные о договоре:**
- `contractNumber` (string) - Номер договора
- `contractStatus` (string) - Статус договора ('Активный', 'Завершенный', 'Начальный')
- `contractSigned` (boolean) - Договор заключен
- `contractDate` (timestamp) - Дата заключения договора
- `contractEndDate` (timestamp) - Дата окончания договора

**Финансовые данные:**
- `totalPrice` (number) - Общая стоимость
- `pricePerM2` (number) - Цена за м²
- `currency` (string) - Валюта
- `paidAmount` (number) - Оплаченная сумма
- `remainingAmount` (number) - Остаток к оплате

**Дополнительная информация:**
- `propertyType` (string) - Тип недвижимости
- `salesManager` (string) - Менеджер по продажам
- `status` (string) - Статус квартиры
- `createdAt` (timestamp) - Дата создания записи
- `updatedAt` (timestamp) - Дата последнего обновления

**ID документа:** Номер квартиры (например, "01-222")

### 3. clients (Клиенты)
Коллекция верхнего уровня с нормализованными данными владельцев.

```
/clients/{clientId}
```

**Поля документа:**
- `fullName` (string) - ФИО клиента
- `phone` (string) - Телефон (нормализованный формат +998...)
- `passportNumber` (string) - Номер паспорта
- `clientAddress` (string) - Адрес клиента
- `apartmentIds` (array) - Массив ID квартир, принадлежащих клиенту
- `email` (string) - Email клиента (опционально)
- `clientType` (string) - Тип клиента (физ. лицо, юр. лицо)
- `isActive` (boolean) - Активен ли клиент
- `createdAt` (timestamp) - Дата создания записи
- `updatedAt` (timestamp) - Дата последнего обновления

**ID документа:** Нормализованный номер паспорта (удалены все спецсимволы, приведено к верхнему регистру)

## Процесс авторизации

### 1. Первичная авторизация
1. Пользователь вводит номер телефона и номер квартиры
2. Система ищет квартиру по всем блокам:
   ```
   blocks/{blockId}/apartments/
   where apartmentNumber == input_apartment
   where phone == input_phone
   ```
3. Если квартира найдена, отправляется SMS для подтверждения

### 2. Поиск всех квартир владельца
После успешной авторизации:
1. Извлекается `passportNumber` из найденной квартиры
2. Поиск всех квартир по паспорту:
   ```
   blocks/{blockId}/apartments/
   where passportNumber == found_passport
   ```
3. Результат - список всех квартир владельца во всех блоках

## Правила безопасности

1. **Аутентификация обязательна** для всех операций чтения/записи
2. **Чтение квартир** разрешено только если:
   - Номер телефона пользователя совпадает с полем `phone` квартиры
   - Или паспорт пользователя есть в документе клиента
3. **Запись данных** из клиентского приложения запрещена
4. **Клиенты** могут читать только свои данные
5. **Обновление клиентских данных** ограничено полями `email` и `clientAddress`

## Оптимизация и производительность

### Денормализация данных
Данные владельца дублируются в документах квартир для:
- Быстрого поиска без дополнительных запросов
- Отображения информации без JOIN операций
- Поддержки offline режима

### Индексы
Рекомендуемые составные индексы:
1. `blocks/{blockId}/apartments` - `apartmentNumber` + `phone`
2. `blocks/{blockId}/apartments` - `passportNumber`
3. `clients` - `phone`
4. `clients` - `passportNumber`

### Альтернативная структура
Для больших объемов данных можно использовать единую коллекцию `apartments`:
```
/apartments/{apartmentId}
```
где `apartmentId` = `{blockId}_{apartmentNumber}`

Это упростит поиск по всем блокам одним запросом.

## Миграция данных

Для импорта данных из Excel используйте скрипт:
```bash
dart run scripts/import_data_to_firestore.dart
```

Скрипт:
1. Читает данные из Excel файла
2. Фильтрует только заключенные договоры
3. Создает документы блоков
4. Импортирует квартиры в подколлекции
5. Создает уникальные документы клиентов
6. Выводит статистику импорта 