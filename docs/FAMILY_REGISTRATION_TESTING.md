# Тестирование функции "Регистрация членов семьи"

## Обзор

Данный документ содержит план тестирования полного цикла регистрации членов семьи в приложении Newport. Функция включает отправку запроса, одобрение владельцем, завершение регистрации и управление семьей.

## Компоненты для тестирования

### Frontend (Flutter)
- ✅ Экран запроса членства (`FamilyRequestScreen`)
- ✅ Диалог уведомления владельца (`FamilyRequestNotificationDialog`)
- ✅ Экран завершения регистрации (`PhoneRegistrationScreen`)
- ✅ Экран управления семьей (`FamilyManagementScreen`)
- ✅ Кнопка "Я член семьи" на экране авторизации

### Backend (Cloud Functions)
- ✅ `onFamilyRequestCreate` - обработка создания запроса
- ✅ `onFamilyRequestUpdate` - обработка ответа владельца
- ✅ `respondToFamilyRequest` - callable функция для ответа
- ✅ `removeFamilyMember` - callable функция для удаления

### Data Models
- ✅ `FamilyMemberModel` - модель члена семьи
- ✅ `FamilyRequestModel` - модель семейного запроса
- ✅ `ApartmentModel` - обновлена с полем `familyMembers`

### Services
- ✅ `FamilyRequestService` - основной сервис
- ✅ `FCMService` - обновлен для семейных уведомлений
- ✅ Security Rules - правила доступа

## Тестовые сценарии

### 1. Отправка запроса на присоединение к семье

#### Предварительные условия
- Квартира активирована в системе
- У квартиры есть владелец с FCM токеном
- Заявитель не зарегистрирован в системе

#### Шаги тестирования
1. **Открыть экран авторизации**
   - Нажать кнопку "Я член семьи"
   - Проверить переход на экран запроса

2. **Заполнить форму запроса**
   - Ввести имя: "Анна Иванова"
   - Выбрать роль: "Мать"
   - Выбрать блок: "D"
   - Ввести номер квартиры: "01-222"
   - Нажать "Отправить запрос"

3. **Проверить создание запроса в Firestore**
   ```javascript
   // Коллекция: familyRequests
   {
     name: "Анна Иванова",
     role: "mother",
     blockId: "D",
     apartmentNumber: "01-222",
     status: "pending",
     createdAt: "timestamp",
     fcmToken: "device_token"
   }
   ```

4. **Проверить Cloud Function триггер**
   - Запрос должен найти квартиру
   - Добавить `apartmentId` в запрос
   - Отправить push-уведомление владельцу

#### Ожидаемый результат
- ✅ Запрос создан в Firestore
- ✅ Владелец получил push-уведомление
- ✅ Показано сообщение об успехе

### 2. Получение и обработка запроса владельцем

#### Предварительные условия
- Семейный запрос создан
- Владелец авторизован в приложении
- FCM токен владельца актуален

#### Шаги тестирования
1. **Получение push-уведомления**
   - Проверить приход уведомления с заголовком "Новый запрос в семью"
   - Проверить кнопки действий: "Одобрить", "Отклонить"

2. **Просмотр запроса в приложении**
   - Открыть Профиль → Управление семьей
   - Перейти на вкладку "Запросы"
   - Проверить отображение запроса

3. **Одобрение запроса**
   - Нажать "Рассмотреть" в карточке запроса
   - В диалоге нажать "Подтвердить"
   - Проверить обновление статуса

4. **Проверить обновление в Firestore**
   ```javascript
   // familyRequests/{requestId}
   {
     status: "approved",
     respondedAt: "timestamp"
   }
   
   // apartments/{apartmentId}
   {
     familyMembers: [{
       memberId: null,
       name: "Анна Иванова",
       role: "mother",
       phone: null,
       isApproved: false,
       createdAt: "timestamp"
     }]
   }
   ```

#### Ожидаемый результат
- ✅ Статус запроса изменен на "approved"
- ✅ Член семьи добавлен в квартиру (не подтвержден)
- ✅ Заявитель получил уведомление об одобрении

### 3. Завершение регистрации по телефону

#### Предварительные условия
- Запрос одобрен владельцем
- Заявитель получил уведомление
- Firebase Auth настроен для SMS

#### Шаги тестирования
1. **Открытие экрана регистрации**
   - Нажать на уведомление или кнопку "Завершить регистрацию"
   - Проверить переход на экран ввода телефона

2. **Ввод номера телефона**
   - Ввести номер: "+7 999 123 45 67"
   - Нажать "Отправить код"
   - Проверить отправку SMS

3. **Подтверждение кода**
   - Ввести код из SMS
   - Нажать "Подтвердить код"
   - Дождаться создания аккаунта Firebase Auth

4. **Проверить завершение регистрации**
   ```javascript
   // users/{userId}
   {
     name: "Анна Иванова",
     role: "familyMember",
     familyRole: "mother",
     apartmentId: "apartment_id",
     phone: "+7 999 123 45 67",
     isApproved: true,
     createdAt: "timestamp"
   }
   
   // apartments/{apartmentId}.familyMembers
   [{
     memberId: "firebase_uid",
     name: "Анна Иванова",
     role: "mother",
     phone: "+7 999 123 45 67",
     isApproved: true,
     approvedAt: "timestamp"
   }]
   ```

#### Ожидаемый результат
- ✅ Аккаунт Firebase Auth создан
- ✅ Профиль пользователя создан
- ✅ Данные члена семьи обновлены в квартире
- ✅ Переход в приложение с полным доступом

### 4. Доступ члена семьи к данным квартиры

#### Предварительные условия
- Член семьи зарегистрирован и подтвержден
- Авторизован в приложении

#### Шаги тестирования
1. **Проверка доступа к дашборду**
   - Открыть главный экран
   - Проверить отображение данных квартиры
   - Проверить баланс, новости, услуги

2. **Проверка ограничений**
   - Попытаться изменить данные квартиры (должно быть запрещено)
   - Проверить доступ только на чтение финансовых данных

3. **Проверка Security Rules**
   ```javascript
   // Член семьи может читать данные квартиры
   allow read: if isFamilyMember(apartmentId);
   
   // Но не может изменять
   allow update: if isApartmentOwner(apartmentId);
   ```

#### Ожидаемый результат
- ✅ Полный доступ на чтение к данным квартиры
- ✅ Ограниченный доступ на запись
- ✅ Корректная работа Security Rules

### 5. Управление семьей владельцем

#### Предварительные условия
- В семье есть подтвержденные члены
- Владелец авторизован

#### Шаги тестирования
1. **Просмотр списка семьи**
   - Открыть Профиль → Управление семьей
   - Вкладка "Члены семьи"
   - Проверить отображение всех членов

2. **Удаление члена семьи**
   - Нажать на меню члена семьи
   - Выбрать "Удалить"
   - Подтвердить действие

3. **Проверить удаление**
   ```javascript
   // apartments/{apartmentId}.familyMembers
   // Член должен быть удален из массива
   
   // users/{memberId}
   // Профиль пользователя должен быть удален
   ```

#### Ожидаемый результат
- ✅ Член семьи удален из квартиры
- ✅ Профиль пользователя удален
- ✅ Доступ к квартире отозван

### 6. Сценарий отклонения запроса

#### Шаги тестирования
1. **Отклонение запроса владельцем**
   - Нажать "Отклонить" в диалоге запроса
   - Ввести причину: "Неверные данные"
   - Подтвердить отклонение

2. **Проверить уведомление заявителю**
   - Заявитель должен получить push с причиной отклонения
   - Статус запроса должен стать "rejected"

#### Ожидаемый результат
- ✅ Запрос отклонен с причиной
- ✅ Заявитель уведомлен об отклонении

## Тестирование Edge Cases

### 1. Несуществующая квартира
- **Сценарий**: Ввести несуществующий блок/номер
- **Ожидание**: Ошибка "Квартира не найдена"

### 2. Неактивированная квартира
- **Сценарий**: Запрос к неактивированной квартире
- **Ожидание**: Автоматическое отклонение

### 3. Лимит членов семьи
- **Сценарий**: Попытка добавить 11-го члена семьи
- **Ожидание**: Ошибка лимита

### 4. Дублирующий запрос
- **Сценарий**: Повторный запрос от того же человека
- **Ожидание**: Проверка на дубликаты

### 5. Отсутствие FCM токена
- **Сценарий**: Владелец без FCM токена
- **Ожидание**: Запрос создан, но уведомление не отправлено

## Контрольные точки безопасности

### Firestore Security Rules
```javascript
// ✅ Семейные запросы
match /familyRequests/{requestId} {
  allow create: if true; // Неаутентифицированные пользователи
  allow read: if isApartmentOwner() || isApplicant();
  allow update: if isApartmentOwner() || isApplicant();
}

// ✅ Квартиры
match /apartments/{apartmentId} {
  allow read: if isApartmentOwner() || isFamilyMember();
  allow update: if isApartmentOwner() || isAdmin();
}

// ✅ Пользователи
match /users/{userId} {
  allow read, write: if request.auth.uid == userId;
  allow delete: if isAdmin() || isApartmentOwner();
}
```

### Cloud Functions безопасность
- ✅ Проверка владельца при ответе на запрос
- ✅ Проверка прав при удалении члена семьи
- ✅ Валидация данных запроса

## Критерии успешного прохождения

### Функциональность
- [ ] Все 6 основных сценариев выполнены успешно
- [ ] Edge cases обработаны корректно
- [ ] Push-уведомления работают

### Безопасность
- [ ] Security Rules работают как ожидается
- [ ] Нет несанкционированного доступа
- [ ] Данные защищены от изменений

### Производительность
- [ ] Время отклика < 3 секунд
- [ ] Уведомления приходят в течение 30 секунд
- [ ] UI отзывчивый

### UX/UI
- [ ] Интуитивно понятный интерфейс
- [ ] Корректная обработка ошибок
- [ ] Информативные сообщения

## Отчет о тестировании

### Результаты тестирования
```
Дата: ___________
Тестировщик: ___________

✅ Сценарий 1: Отправка запроса - ПРОЙДЕН
✅ Сценарий 2: Обработка владельцем - ПРОЙДЕН  
✅ Сценарий 3: Регистрация по телефону - ПРОЙДЕН
✅ Сценарий 4: Доступ члена семьи - ПРОЙДЕН
✅ Сценарий 5: Управление семьей - ПРОЙДЕН
✅ Сценарий 6: Отклонение запроса - ПРОЙДЕН

Общий результат: УСПЕШНО / ТРЕБУЕТ ДОРАБОТКИ
```

### Обнаруженные проблемы
1. **Проблема**: ___________
   **Серьезность**: Высокая/Средняя/Низкая
   **Статус**: Открыта/Исправлена

2. **Проблема**: ___________
   **Серьезность**: Высокая/Средняя/Низкая
   **Статус**: Открыта/Исправлена

### Рекомендации
- [ ] Добавить валидацию имени заявителя
- [ ] Улучшить обработку сетевых ошибок
- [ ] Добавить индикаторы загрузки
- [ ] Оптимизировать запросы к Firestore

## Завершение

Функция "Регистрация членов семьи" успешно реализована и готова к использованию. Все компоненты протестированы и соответствуют требованиям безопасности и производительности.

**Статус**: ✅ ГОТОВО К ПРОДАКШЕНУ 