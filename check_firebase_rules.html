<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∞–≤–∏–ª Firebase</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 { color: #1f2937; margin-bottom: 20px; }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
        }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        
        .test-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 8px 4px;
            transition: background-color 0.2s;
        }
        button:hover { background: #2563eb; }
        button:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        .log {
            background: #111827;
            color: #f3f4f6;
            padding: 16px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin: 16px 0;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-pending { background: #f59e0b; }
        
        .quick-fix {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }
        .quick-fix h3 {
            color: #1e40af;
            margin-top: 0;
            margin-bottom: 16px;
        }
        .step {
            margin: 12px 0;
            padding-left: 24px;
            position: relative;
        }
        .step:before {
            content: counter(step);
            counter-increment: step;
            position: absolute;
            left: 0;
            top: 0;
            background: #3b82f6;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .steps {
            counter-reset: step;
        }
        
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∞–≤–∏–ª Firebase</h1>
        
        <div class="alert alert-info">
            <strong>üéØ –¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∞–≤–∏–ª Firestore –∏ Storage, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ <code>userProfiles</code>
        </div>

        <div id="authStatus" class="alert alert-warning">
            <span class="status-indicator status-pending"></span>
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...
        </div>

        <div class="test-card">
            <div class="test-title">üîç –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
            <button onclick="runQuickDiagnosis()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
            <button onclick="testSpecificError()">‚ö° –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–∫—É –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
        </div>

        <div class="test-card">
            <div class="test-title">üìã –¢–æ—á–µ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã</div>
            <button onclick="testUserProfilesWrite()">üìù –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ userProfiles</button>
            <button onclick="testUserProfilesRead()">üëÅ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è userProfiles</button>
            <button onclick="testStorageUpload()">üì∏ –¢–µ—Å—Ç Storage</button>
            <button onclick="testAuthToken()">üîê –¢–µ—Å—Ç Auth —Ç–æ–∫–µ–Ω–∞</button>
        </div>

        <div id="results"></div>
        
        <div class="quick-fix">
            <h3>‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ</h3>
            <div class="steps">
                <div class="step">–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></div>
                <div class="step">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç <strong>newport-23a19</strong></div>
                <div class="step">Firestore Database ‚Üí Rules</div>
                <div class="step">–ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞: <code>allow read, write: if true;</code></div>
                <div class="step">–ù–∞–∂–º–∏—Ç–µ <strong>Publish</strong></div>
            </div>
        </div>

        <div class="log" id="logContainer">–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...\n</div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="clearLog()" style="background: #6b7280;">üóë –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDVy8OhKiDW8CPOJ2yUnx-ov5WkOYa8WMg",
            authDomain: "newport-23a19.firebaseapp.com",
            projectId: "newport-23a19",
            storageBucket: "newport-23a19.firebasestorage.app",
            messagingSenderId: "254421846823",
            appId: "1:254421846823:web:8f1742dfd38b0b38bce866"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#60a5fa',
                success: '#34d399', 
                error: '#f87171',
                warning: '#fbbf24'
            };
            
            logContainer.innerHTML += `<span style="color: ${colors[type]};">[${timestamp}] ${message}</span>\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showResult(message, type, details = '') {
            const results = document.getElementById('results');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const indicator = type === 'success' ? 'status-success' : 
                            type === 'error' ? 'status-error' : 'status-pending';
                            
            alert.innerHTML = `
                <span class="status-indicator ${indicator}"></span>
                <strong>${message}</strong>
                ${details ? `<div style="margin-top: 8px; font-weight: normal;">${details}</div>` : ''}
            `;
            results.appendChild(alert);
        }

        window.clearLog = () => {
            document.getElementById('logContainer').innerHTML = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...\n';
            document.getElementById('results').innerHTML = '';
        };

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è  
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authStatus = document.getElementById('authStatus');
            
            if (user) {
                authStatus.className = 'alert alert-success';
                authStatus.innerHTML = `
                    <span class="status-indicator status-success"></span>
                    –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: <code>${user.uid}</code> (${user.isAnonymous ? '–∞–Ω–æ–Ω–∏–º–Ω–æ' : '–æ–±—ã—á–Ω–æ'})
                `;
                log(`‚úÖ Auth OK: ${user.uid.substring(0,8)}... (–∞–Ω–æ–Ω–∏–º–Ω–æ: ${user.isAnonymous})`, 'success');
            } else {
                authStatus.className = 'alert alert-warning';
                authStatus.innerHTML = `
                    <span class="status-indicator status-pending"></span>
                    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...
                `;
                
                signInAnonymously(auth).catch((error) => {
                    authStatus.className = 'alert alert-error';
                    authStatus.innerHTML = `
                        <span class="status-indicator status-error"></span>
                        –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}
                    `;
                    log(`‚ùå Auth failed: ${error.message}`, 'error');
                });
            }
        });

        // –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        window.runQuickDiagnosis = async function() {
            log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
            clearLog();
            
            const tests = [
                { name: '–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è', func: testAuth },
                { name: '–ó–∞–ø–∏—Å—å userProfiles', func: testUserProfilesWrite },
                { name: '–ß—Ç–µ–Ω–∏–µ userProfiles', func: testUserProfilesRead },
                { name: 'Storage upload', func: testStorageUpload }
            ];

            for (const test of tests) {
                try {
                    log(`üîÑ –¢–µ—Å—Ç: ${test.name}`, 'info');
                    await test.func();
                    log(`‚úÖ ${test.name}: –ü–†–û–®–ï–õ`, 'success');
                } catch (error) {
                    log(`‚ùå ${test.name}: –ü–†–û–í–ê–õ–ï–ù - ${error.message}`, 'error');
                }
            }
            
            showResult('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'info', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π');
        };

        // –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Ç–æ—á–Ω–æ–π –æ—à–∏–±–∫–∏ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.testSpecificError = async function() {
            if (!currentUser) {
                showResult('–û—à–∏–±–∫–∞', 'error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
                return;
            }

            log('‚ö° –ü–æ–≤—Ç–æ—Ä—è–µ–º —Ç–æ—á–Ω—É—é –æ—à–∏–±–∫—É –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'warning');
            
            // –¢–µ—Å—Ç 1: –ü–æ UID (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ)
            try {
                log(`üîÑ –¢–µ—Å—Ç 1: –ó–∞–ø–∏—Å—å –ø–æ UID ${currentUser.uid}`, 'info');
                
                const userDoc = doc(firestore, 'userProfiles', currentUser.uid);
                await setDoc(userDoc, {
                    uid: currentUser.uid,
                    fullName: 'OTABEK USKENBAYEV SAIDAXMAD O\'G\'LI',
                    phone: '+998999357706',
                    role: 'resident',
                    apartmentNumber: '203',
                    blockId: 'F',
                    lastLogin: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    isAnonymous: currentUser.isAnonymous,
                    dataSource: 'web_diagnostic_uid'
                }, { merge: true });
                
                log('‚úÖ –ó–∞–ø–∏—Å—å –ø–æ UID —É—Å–ø–µ—à–Ω–∞!', 'success');
                showResult('–¢–µ—Å—Ç –ø–æ UID –ø—Ä–æ—à–µ–ª', 'success');
                
            } catch (error) {
                log(`‚ùå –ó–∞–ø–∏—Å—å –ø–æ UID –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: ${error.message}`, 'error');
                showResult('–¢–µ—Å—Ç –ø–æ UID –ø—Ä–æ–≤–∞–ª–µ–Ω', 'error', `–ö–æ–¥: ${error.code}, –°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`);
            }

            // –¢–µ—Å—Ç 2: –ü–æ –ø–∞—Å–ø–æ—Ä—Ç—É (–∫–∞–∫ –≤–æ –≤—Ç–æ—Ä–æ–π –æ—à–∏–±–∫–µ)
            try {
                log('üîÑ –¢–µ—Å—Ç 2: –ó–∞–ø–∏—Å—å –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É AD2444681', 'info');
                
                const passportDoc = doc(firestore, 'userProfiles', 'AD2444681');
                await setDoc(passportDoc, {
                    uid: currentUser.uid,
                    passportNumber: 'AD2444681',
                    fullName: 'OTABEK USKENBAYEV SAIDAXMAD O\'G\'LI',
                    phone: '+998999357706',
                    role: 'resident',
                    apartmentNumber: '203',
                    blockId: 'F',
                    lastLogin: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    dataSource: 'web_diagnostic_passport'
                }, { merge: true });
                
                log('‚úÖ –ó–∞–ø–∏—Å—å –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É —É—Å–ø–µ—à–Ω–∞!', 'success');
                showResult('–¢–µ—Å—Ç –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É –ø—Ä–æ—à–µ–ª', 'success');
                
            } catch (error) {
                log(`‚ùå –ó–∞–ø–∏—Å—å –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: ${error.message}`, 'error');
                showResult('–¢–µ—Å—Ç –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É –ø—Ä–æ–≤–∞–ª–µ–Ω', 'error', `–ö–æ–¥: ${error.code}, –°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`);
            }
        };

        // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
        async function testAuth() {
            if (!currentUser) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
            const token = await currentUser.getIdToken();
            log(`Auth —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω (${token.length} —Å–∏–º–≤–æ–ª–æ–≤)`, 'success');
        }

        window.testUserProfilesWrite = async function() {
            try {
                await testAuth();
                
                const testDoc = doc(firestore, 'userProfiles', 'test_' + Date.now());
                await setDoc(testDoc, {
                    test: true,
                    timestamp: serverTimestamp(),
                    user: currentUser.uid
                });
                
                log('‚úÖ –ó–∞–ø–∏—Å—å –≤ userProfiles —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
                showResult('–ó–∞–ø–∏—Å—å userProfiles', 'success');
            } catch (error) {
                log(`‚ùå –ó–∞–ø–∏—Å—å userProfiles: ${error.message}`, 'error');
                showResult('–ó–∞–ø–∏—Å—å userProfiles', 'error', error.message);
            }
        };

        window.testUserProfilesRead = async function() {
            try {
                const testDoc = doc(firestore, 'userProfiles', 'AD2444681');
                const docSnap = await getDoc(testDoc);
                
                if (docSnap.exists()) {
                    log('‚úÖ –ß—Ç–µ–Ω–∏–µ userProfiles —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω', 'success');
                    showResult('–ß—Ç–µ–Ω–∏–µ userProfiles', 'success', '–î–æ–∫—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω');
                } else {
                    log('‚ö†Ô∏è –ß—Ç–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
                    showResult('–ß—Ç–µ–Ω–∏–µ userProfiles', 'warning', '–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (error) {
                log(`‚ùå –ß—Ç–µ–Ω–∏–µ userProfiles: ${error.message}`, 'error');
                showResult('–ß—Ç–µ–Ω–∏–µ userProfiles', 'error', error.message);
            }
        };

        window.testStorageUpload = async function() {
            try {
                await testAuth();
                
                const testData = new Blob(['test'], { type: 'text/plain' });
                const testRef = ref(storage, `test/${Date.now()}/test.txt`);
                await uploadBytes(testRef, testData);
                
                log('‚úÖ Storage upload —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
                showResult('Storage upload', 'success');
            } catch (error) {
                log(`‚ùå Storage upload: ${error.message}`, 'error');
                showResult('Storage upload', 'error', error.message);
            }
        };

        window.testAuthToken = async function() {
            try {
                await testAuth();
                showResult('Auth —Ç–æ–∫–µ–Ω', 'success', '–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
            } catch (error) {
                showResult('Auth —Ç–æ–∫–µ–Ω', 'error', error.message);
            }
        };
    </script>
</body>
</html> 