<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - Newport Resident</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .section {
            margin: 30px 0;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #bd2130);
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;

        

        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .diagnostics {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .token-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
        .progress {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 25px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            text-align: center;
            transition: all 0.3s;
        }
        .card:hover {
            border-color: #007bff;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,123,255,0.1);
        }
        .test-message {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .emoji {
            font-size: 1.5em;
            margin-right: 10px;
        }
        .small-text {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h1>
        <p style="text-align: center; color: #666; font-size: 1.1em;">
            –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        </p>

        <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
        <div class="section">
            <h3><span class="emoji">üîç</span>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FCM —Å–µ—Ä–≤–∏—Å–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.</p>
            <button onclick="runDiagnostics()" id="diagBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
            <div id="diagnosticsResult" class="diagnostics" style="display: none;"></div>
            <div id="progressContainer" style="display: none;">
                <div class="progress">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–ª—É—á–µ–Ω–∏–µ FCM —Ç–æ–∫–µ–Ω–∞ -->
        <div class="section">
            <h3><span class="emoji">üì±</span>–ü–æ–ª—É—á–µ–Ω–∏–µ FCM —Ç–æ–∫–µ–Ω–∞</h3>
            <p>–ü–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>
            <button onclick="getFCMToken()" id="tokenBtn">–ü–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω</button>
            <button onclick="copyTokenToClipboard()" id="copyTokenBtn" style="display: none;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
            <div id="fcmTokenResult" class="token-display" style="display: none;"></div>
        </div>

        <!-- –ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ -->
        <div class="section">
            <h3><span class="emoji">üîé</span>–ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤</h3>
            <div class="form-group">
                <label for="searchPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                <input type="tel" id="searchPhone" placeholder="+998998071400" value="+998998071400">
            </div>
            <div class="form-group">
                <label for="searchBlock">–ë–ª–æ–∫:</label>
                <select id="searchBlock">
                    <option value="">–í—Å–µ –±–ª–æ–∫–∏</option>
                    <option value="D BLOK">D BLOK</option>
                    <option value="E BLOK">E BLOK</option>
                    <option value="F BLOK">F BLOK</option>
                    <option value="G BLOK">G BLOK</option>
                    <option value="H BLOK">H BLOK</option>
                    <option value="I BLOK">I BLOK</option>
                    <option value="J BLOK">J BLOK</option>
                    <option value="O3">O3</option>
                    <option value="O5">O5</option>
                </select>
            </div>
            <div class="form-group">
                <label for="searchApartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞:</label>
                <input type="text" id="searchApartment" placeholder="102" value="102">
            </div>
            <button onclick="searchTokens()" id="searchBtn">–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω—ã</button>
            <div id="tokenSearchResult" style="display: none;"></div>
        </div>

        <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ -->
        <div class="section">
            <h3><span class="emoji">üíæ</span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ FCM —Ç–æ–∫–µ–Ω–∞</h3>
            <div class="form-group">
                <label for="saveBlock">–ë–ª–æ–∫:</label>
                <select id="saveBlock" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫</option>
                    <option value="D BLOK">D BLOK</option>
                    <option value="E BLOK">E BLOK</option>
                    <option value="F BLOK">F BLOK</option>
                    <option value="G BLOK">G BLOK</option>
                    <option value="H BLOK">H BLOK</option>
                    <option value="I BLOK">I BLOK</option>
                    <option value="J BLOK">J BLOK</option>
                    <option value="O3">O3</option>
                    <option value="O5">O5</option>
                </select>
            </div>
            <div class="form-group">
                <label for="saveApartment">–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã:</label>
                <input type="text" id="saveApartment" placeholder="102" value="102" required>
            </div>
            <div class="form-group">
                <label for="customToken">FCM —Ç–æ–∫–µ–Ω (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è):</label>
                <textarea id="customToken" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ FCM —Ç–æ–∫–µ–Ω –∑–¥–µ—Å—å –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º"></textarea>
            </div>
            <button onclick="saveTokenToApartment()" id="saveTokenBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        </div>

        <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
        <div class="section">
            <h3><span class="emoji">üß™</span>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
            <div class="test-message">
                <p><strong>–í–∞–∂–Ω–æ:</strong> –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π FCM —Ç–æ–∫–µ–Ω.</p>
            </div>
            
            <div class="form-group">
                <label for="testToken">FCM —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∞:</label>
                <input type="text" id="testToken" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ FCM —Ç–æ–∫–µ–Ω –≤—ã—à–µ">
                <button onclick="useCurrentToken()" type="button" style="margin-top: 10px;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω</button>
            </div>
            
            <div class="form-group">
                <label for="testTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
                <input type="text" id="testTitle" value="–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Newport" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
            </div>
            
            <div class="form-group">
                <label for="testMessage">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
                <textarea id="testMessage" rows="3" placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">üè† –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${new Date().toLocaleString('ru-RU')}</textarea>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h4>üì¢ –û–±—ã—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h4>
                    <button onclick="sendTestNotification('normal')" class="btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <div class="small-text">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
                </div>
                <div class="card">
                    <h4>üö® –í–∞–∂–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h4>
                    <button onclick="sendTestNotification('important')" class="btn-warning">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <div class="small-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º</div>
                </div>
                <div class="card">
                    <h4>üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h4>
                    <button onclick="sendTestNotification('critical')" class="btn-danger">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <div class="small-text">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∑–≤—É–∫–æ–º</div>
                </div>
            </div>
        </div>

        <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º -->
        <div class="section">
            <h3><span class="emoji">üîß</span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.</p>
            <div class="grid">
                <div class="card">
                    <h4>üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω</h4>
                    <button onclick="recreateFCMToken()">–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å</button>
                    <div class="small-text">–ü–æ–ª—É—á–∏—Ç –Ω–æ–≤—ã–π FCM —Ç–æ–∫–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <div class="card">
                    <h4>üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</h4>
                    <button onclick="clearNotificationCache()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <div class="small-text">–û—á–∏—Å—Ç–∏—Ç –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è FCM</div>
                </div>
                <div class="card">
                    <h4>üîê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</h4>
                    <button onclick="checkPermissions()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                    <div class="small-text">–ü—Ä–æ–≤–µ—Ä–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                </div>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
        import { getMessaging, getToken, isSupported } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC8xhHaOKdtlHLEDjGU0u1zl1YwdO6vfHA",
            authDomain: "newport-resident.firebaseapp.com",
            projectId: "newport-resident",
            storageBucket: "newport-resident.appspot.com",
            messagingSenderId: "1051980510754",
            appId: "1:1051980510754:web:bbf41c1a9af4caba03cd06",
            measurementId: "G-7J3NQT4V88"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let messaging = null;
        let currentFCMToken = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FCM
        async function initializeMessaging() {
            try {
                const supported = await isSupported();
                if (supported) {
                    messaging = getMessaging(app);
                    showStatus('‚úÖ Firebase Messaging –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
                    return true;
                } else {
                    showStatus('‚ùå Firebase Messaging –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
                    return false;
                }
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FCM: ${error.message}`, 'error');
                return false;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            statusDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function addToDiagnostics(message) {
            const diagnosticsDiv = document.getElementById('diagnosticsResult');
            diagnosticsDiv.style.display = 'block';
            diagnosticsDiv.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
            diagnosticsDiv.scrollTop = diagnosticsDiv.scrollHeight;
        }

        function updateProgress(percent, text = '') {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = text || `${percent}%`;
        }

        async function runDiagnostics() {
            const diagBtn = document.getElementById('diagBtn');
            diagBtn.disabled = true;
            diagBtn.textContent = '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞...';
            
            const diagnosticsDiv = document.getElementById('diagnosticsResult');
            diagnosticsDiv.innerHTML = '';
            diagnosticsDiv.style.display = 'block';
            
            try {
                updateProgress(10, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞...');
                addToDiagnostics('üîç –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                addToDiagnostics(`üì± User Agent: ${navigator.userAgent}`);
                addToDiagnostics(`üåê URL: ${window.location.href}`);
                addToDiagnostics(`üîê HTTPS: ${window.location.protocol === 'https:'}`);
                
                updateProgress(20, '–ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker...');
                if ('serviceWorker' in navigator) {
                    addToDiagnostics('‚úÖ Service Worker –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    const registration = await navigator.serviceWorker.getRegistration();
                    addToDiagnostics(`üìã Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${!!registration}`);
                } else {
                    addToDiagnostics('‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                }
                
                updateProgress(30, '–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');
                addToDiagnostics(`üîî Notification API: ${'Notification' in window}`);
                if ('Notification' in window) {
                    addToDiagnostics(`üîê –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${Notification.permission}`);
                }
                
                updateProgress(50, '–ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase...');
                const messagingSupported = await initializeMessaging();
                addToDiagnostics(`üî• Firebase Messaging: ${messagingSupported ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}`);
                
                updateProgress(70, '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
                try {
                    const testDoc = await getDoc(doc(db, 'test', 'connection'));
                    addToDiagnostics('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firestore —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } catch (error) {
                    addToDiagnostics(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firestore: ${error.message}`);
                }
                
                updateProgress(90, '–ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–∞...');
                if (messaging) {
                    try {
                        const token = await getToken(messaging, { 
                            vapidKey: 'BEHMYWsYFvITZOcxNnPTB5U1g51rYBQMW8R7t9IuFrYo_dxSqy0m2VHk5t9Q_GFcvP_Y' 
                        });
                        if (token) {
                            addToDiagnostics(`‚úÖ FCM —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${token.substring(0, 30)}...`);
                            currentFCMToken = token;
                        } else {
                            addToDiagnostics('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω');
                        }
                    } catch (error) {
                        addToDiagnostics(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è FCM —Ç–æ–∫–µ–Ω–∞: ${error.message}`);
                    }
                }
                
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ');
                addToDiagnostics('üéâ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                showStatus('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (error) {
                addToDiagnostics(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                showStatus(`‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`, 'error');
            } finally {
                diagBtn.disabled = false;
                diagBtn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É';
            }
        }

        async function getFCMToken() {
            const tokenBtn = document.getElementById('tokenBtn');
            tokenBtn.disabled = true;
            tokenBtn.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞...';
            
            try {
                if (!messaging) {
                    const initialized = await initializeMessaging();
                    if (!initialized) return;
                }

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showStatus('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                    return;
                }

                showStatus('‚è≥ –ü–æ–ª—É—á–∞–µ–º FCM —Ç–æ–∫–µ–Ω...', 'info');
                
                const token = await getToken(messaging, {
                    vapidKey: 'BEHMYWsYFvITZOcxNnPTB5U1g51rYBQMW8R7t9IuFrYo_dxSqy0m2VHk5t9Q_GFcvP_Y'
                });

                if (token) {
                    currentFCMToken = token;
                    const tokenResult = document.getElementById('fcmTokenResult');
                    const copyBtn = document.getElementById('copyTokenBtn');
                    
                    tokenResult.textContent = token;
                    tokenResult.style.display = 'block';
                    copyBtn.style.display = 'inline-block';
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    document.getElementById('customToken').value = token;
                    document.getElementById('testToken').value = token;
                    
                    showStatus('‚úÖ FCM —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!', 'success');
                } else {
                    showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è FCM —Ç–æ–∫–µ–Ω–∞:', error);
                showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            } finally {
                tokenBtn.disabled = false;
                tokenBtn.textContent = '–ü–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω';
            }
        }

        async function copyTokenToClipboard() {
            try {
                await navigator.clipboard.writeText(currentFCMToken);
                showStatus('‚úÖ FCM —Ç–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            } catch (error) {
                showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω', 'error');
            }
        }

        async function searchTokens() {
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.textContent = '–ü–æ–∏—Å–∫...';
            
            const phone = document.getElementById('searchPhone').value.trim();
            const block = document.getElementById('searchBlock').value.trim();
            const apartment = document.getElementById('searchApartment').value.trim();
            const resultDiv = document.getElementById('tokenSearchResult');
            
            try {
                let results = [];
                
                // –ü–æ–∏—Å–∫ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö
                if (block && apartment) {
                    try {
                        const apartmentDoc = await getDoc(doc(db, 'users', block, 'apartments', apartment));
                        if (apartmentDoc.exists()) {
                            const data = apartmentDoc.data();
                            results.push({
                                source: `users/${block}/apartments/${apartment}`,
                                pushToken: data.pushToken,
                                fcmTokens: data.fcmTokens || [],
                                phone: data.phone_number,
                                lastUpdate: data.lastPushTokenUpdate?.toDate?.()?.toLocaleString() || 'N/A'
                            });
                        }
                    } catch (e) {
                        console.log('Apartment document not found:', e.message);
                    }
                }
                
                if (phone) {
                    const normalizedPhone = phone.replace(/[^0-9]/g, '');
                    try {
                        const fcmDoc = await getDoc(doc(db, 'fcm_tokens', normalizedPhone));
                        if (fcmDoc.exists()) {
                            const data = fcmDoc.data();
                            results.push({
                                source: `fcm_tokens/${normalizedPhone}`,
                                tokens: data.tokens || [],
                                phone: data.phoneNumber,
                                block: data.blockId,
                                apartment: data.apartmentNumber,
                                lastUpdate: data.lastTokenUpdate?.toDate?.()?.toLocaleString() || 'N/A'
                            });
                        }
                    } catch (e) {
                        console.log('FCM token document not found:', e.message);
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                resultDiv.style.display = 'block';
                if (results.length === 0) {
                    resultDiv.innerHTML = '<div class="status warning">‚ùå –¢–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                } else {
                    let html = '<h4>üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã:</h4>';
                    results.forEach((result, index) => {
                        html += `
                            <div class="status info" style="margin: 10px 0;">
                                <strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${result.source}<br>
                                <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${result.phone || 'N/A'}<br>
                                ${result.pushToken ? `<strong>Push Token:</strong> ${result.pushToken.substring(0, 30)}...<br>` : ''}
                                ${result.fcmTokens ? `<strong>FCM Tokens:</strong> ${result.fcmTokens.length} —à—Ç.<br>` : ''}
                                ${result.tokens ? `<strong>Tokens:</strong> ${result.tokens.length} —à—Ç.<br>` : ''}
                                <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${result.lastUpdate}
                            </div>
                        `;
                    });
                    resultDiv.innerHTML = html;
                }
                
                showStatus(`‚úÖ –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–∞–π–¥–µ–Ω–æ: ${results.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
                
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}`, 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω—ã';
            }
        }

        async function saveTokenToApartment() {
            const saveBtn = document.getElementById('saveTokenBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            const block = document.getElementById('saveBlock').value.trim();
            const apartment = document.getElementById('saveApartment').value.trim();
            let token = document.getElementById('customToken').value.trim();
            
            if (!block || !apartment) {
                showStatus('‚ùå –£–∫–∞–∂–∏—Ç–µ –±–ª–æ–∫ –∏ –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω';
                return;
            }
            
            try {
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if (!token) {
                    if (!messaging) {
                        const initialized = await initializeMessaging();
                        if (!initialized) return;
                    }
                    
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        showStatus('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ', 'error');
                        return;
                    }
                    
                    token = await getToken(messaging, {
                        vapidKey: 'BEHMYWsYFvITZOcxNnPTB5U1g51rYBQMW8R7t9IuFrYo_dxSqy0m2VHk5t9Q_GFcvP_Y'
                    });
                    
                    if (!token) {
                        showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω', 'error');
                        return;
                    }
                }
                
                currentFCMToken = token;
                showStatus('‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –¥–æ–∫—É–º–µ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã
                const apartmentRef = doc(db, 'users', block, 'apartments', apartment);
                await setDoc(apartmentRef, {
                    pushToken: token,
                    fcmTokens: [token],
                    lastPushTokenUpdate: new Date(),
                    lastTokenUpdate: new Date(),
                    blockName: block,
                    apartmentNumber: apartment
                }, { merge: true });
                
                showStatus(`‚úÖ FCM —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã ${apartment} –≤ –±–ª–æ–∫–µ ${block}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('testToken').value = token;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
                showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω';
            }
        }

        function useCurrentToken() {
            if (currentFCMToken) {
                document.getElementById('testToken').value = currentFCMToken;
                showStatus('‚úÖ –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'success');
            } else {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ FCM —Ç–æ–∫–µ–Ω', 'warning');
            }
        }

        async function sendTestNotification(priority = 'normal') {
            const token = document.getElementById('testToken').value.trim();
            const title = document.getElementById('testTitle').value.trim();
            let message = document.getElementById('testMessage').value.trim();
            
            if (!token) {
                showStatus('‚ùå –£–∫–∞–∂–∏—Ç–µ FCM —Ç–æ–∫–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                return;
            }
            
            if (!title || !message) {
                showStatus('‚ùå –£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                return;
            }
            
            // –ó–∞–º–µ–Ω—è–µ–º —à–∞–±–ª–æ–Ω –≤—Ä–µ–º–µ–Ω–∏
            message = message.replace('${new Date().toLocaleString(\'ru-RU\')}', new Date().toLocaleString('ru-RU'));
            
            try {
                showStatus('‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...', 'info');
                
                // –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Cloud Function –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API FCM –Ω–∞–ø—Ä—è–º—É—é (—Ç—Ä–µ–±—É–µ—Ç server key)
                const response = await fetch('https://fcm.googleapis.com/fcm/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'key=YOUR_SERVER_KEY', // –ù—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–ª—é—á
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: token,
                        notification: {
                            title: title,
                            body: message,
                            priority: priority === 'critical' ? 'high' : 'normal',
                            sound: priority === 'critical' ? 'default' : 'none'
                        },
                        data: {
                            type: 'test',
                            priority: priority,
                            timestamp: Date.now().toString()
                        }
                    })
                });
                
                if (response.ok) {
                    showStatus(`‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (${priority}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
                showStatus(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–ª—é—á FCM.`, 'warning');
                showStatus(`üí° –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ admin –ø–∞–Ω–µ–ª–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.`, 'info');
            }
        }

        async function recreateFCMToken() {
            try {
                showStatus('‚è≥ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º FCM —Ç–æ–∫–µ–Ω...', 'info');
                
                if (!messaging) {
                    const initialized = await initializeMessaging();
                    if (!initialized) return;
                }
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω
                await messaging.deleteToken();
                
                // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showStatus('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ', 'error');
                    return;
                }
                
                const newToken = await getToken(messaging, {
                    vapidKey: 'BEHMYWsYFvITZOcxNnPTB5U1g51rYBQMW8R7t9IuFrYo_dxSqy0m2VHk5t9Q_GFcvP_Y'
                });
                
                if (newToken) {
                    currentFCMToken = newToken;
                    document.getElementById('fcmTokenResult').textContent = newToken;
                    document.getElementById('fcmTokenResult').style.display = 'block';
                    document.getElementById('copyTokenBtn').style.display = 'inline-block';
                    document.getElementById('customToken').value = newToken;
                    document.getElementById('testToken').value = newToken;
                    
                    showStatus('‚úÖ –ù–æ–≤—ã–π FCM —Ç–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω', 'error');
                }
                
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${error.message}`, 'error');
            }
        }

        async function clearNotificationCache() {
            try {
                showStatus('‚è≥ –û—á–∏—â–∞–µ–º –∫—ç—à —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...', 'info');
                
                // –û—á–∏—â–∞–µ–º localStorage
                localStorage.removeItem('fcm_token');
                localStorage.removeItem('notification_permission');
                
                // –û—á–∏—â–∞–µ–º sessionStorage
                sessionStorage.clear();
                
                // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é Service Worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                    }
                }
                
                showStatus('‚úÖ –ö—ç—à —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—á–∏—â–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'success');
                
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞: ${error.message}`, 'error');
            }
        }

        async function checkPermissions() {
            try {
                showStatus('‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...', 'info');
                
                let html = '<div class="status info"><h4>üîê –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:</h4>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                if ('Notification' in window) {
                    html += `<strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</strong> ${Notification.permission}<br>`;
                } else {
                    html += '<strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</strong> –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è<br>';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    html += `<strong>Service Worker:</strong> ${registration ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'}<br>`;
                } else {
                    html += '<strong>Service Worker:</strong> –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è<br>';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase Messaging
                const supported = await isSupported();
                html += `<strong>Firebase Messaging:</strong> ${supported ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}<br>`;
                
                html += '</div>';
                
                showStatus(html, 'info');
                
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: ${error.message}`, 'error');
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.runDiagnostics = runDiagnostics;
        window.getFCMToken = getFCMToken;
        window.copyTokenToClipboard = copyTokenToClipboard;
        window.searchTokens = searchTokens;
        window.saveTokenToApartment = saveTokenToApartment;
        window.useCurrentToken = useCurrentToken;
        window.sendTestNotification = sendTestNotification;
        window.recreateFCMToken = recreateFCMToken;
        window.clearNotificationCache = clearNotificationCache;
        window.checkPermissions = checkPermissions;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async () => {
            await initializeMessaging();
            showStatus('üöÄ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'info');
        });
    </script>
</body>
</html> 