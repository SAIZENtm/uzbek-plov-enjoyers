<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Push –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - Newport</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .secondary {
            background-color: #2196F3;
        }
        .secondary:hover {
            background-color: #1976D2;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .token-info {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #ffeeba;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîî –¢–µ—Å—Ç Push –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - Newport</h1>
        
        <div class="info">
            <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Firestore:</h3>
            <p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:</strong></p>
            <ul>
                <li>users/{blockId}/apartments/{apartmentNumber}</li>
                <li>–ë–ª–æ–∫–∏: A, B, C, D, E, F</li>
                <li>FCM —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–æ–ª–µ fcmTokens –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã</li>
            </ul>
        </div>

        <div class="form-group">
            <label>–ë–ª–æ–∫:</label>
            <select id="blockId">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫</option>
                <option value="A">A BLOK</option>
                <option value="B">B BLOK</option>
                <option value="C">C BLOK</option>
                <option value="D">D BLOK</option>
                <option value="E">E BLOK</option>
                <option value="F">F BLOK</option>
            </select>
        </div>

        <div class="form-group">
            <label>–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã:</label>
            <input type="text" id="apartmentNumber" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 01-222">
        </div>

        <div class="form-group">
            <label>FCM Token (–∏–∑ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è):</label>
            <textarea id="fcmToken" rows="4" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ FCM —Ç–æ–∫–µ–Ω –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"></textarea>
        </div>

        <button onclick="saveToken()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å FCM Token</button>
        <button onclick="checkData()" class="secondary">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>

        <div class="token-info" style="display: none;" id="tokenInfo"></div>

        <hr style="margin: 30px 0;">

        <h2>üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>

        <div class="form-group">
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="title" value="–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">
        </div>

        <div class="form-group">
            <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
            <textarea id="message" rows="3">–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Newport Admin</textarea>
        </div>

        <div class="form-group">
            <label>Passport Number –∏–ª–∏ –¢–µ–ª–µ—Ñ–æ–Ω (userId):</label>
            <input type="text" id="userId" placeholder="AC3077863 –∏–ª–∏ +998901234567">
        </div>

        <button onclick="sendNotification()">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>

        <div id="result" class="result"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyDJ1hQ7UNAQnU-hmsLxZkod3hLGQqsECzA",
            authDomain: "newport-23a19.firebaseapp.com",
            projectId: "newport-23a19",
            storageBucket: "newport-23a19.appspot.com",
            messagingSenderId: "975439026355",
            appId: "1:975439026355:web:64e1e0f9e893f37a2c6dc5"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const functions = firebase.functions();

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function saveToken() {
            const blockId = document.getElementById('blockId').value;
            const apartmentNumber = document.getElementById('apartmentNumber').value;
            const fcmToken = document.getElementById('fcmToken').value.trim();

            if (!blockId || !apartmentNumber || !fcmToken) {
                showResult('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }

            try {
                log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ users/${blockId}/apartments/${apartmentNumber}`);
                
                await db.collection('users')
                    .doc(blockId)
                    .collection('apartments')
                    .doc(apartmentNumber)
                    .update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(fcmToken),
                        lastTokenUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                showResult('‚úÖ FCM Token —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                log('Token —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                checkData();
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function checkData() {
            const blockId = document.getElementById('blockId').value;
            const apartmentNumber = document.getElementById('apartmentNumber').value;

            if (!blockId || !apartmentNumber) {
                showResult('–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã!', 'error');
                return;
            }

            try {
                log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö: users/${blockId}/apartments/${apartmentNumber}`);
                
                const doc = await db.collection('users')
                    .doc(blockId)
                    .collection('apartments')
                    .doc(apartmentNumber)
                    .get();

                if (doc.exists) {
                    const data = doc.data();
                    const tokenInfo = document.getElementById('tokenInfo');
                    tokenInfo.style.display = 'block';
                    tokenInfo.innerHTML = `
                        <h3>‚úÖ –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞!</h3>
                        <p><strong>–ë–ª–æ–∫:</strong> ${blockId}</p>
                        <p><strong>–ö–≤–∞—Ä—Ç–∏—Ä–∞:</strong> ${apartmentNumber}</p>
                        <p><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${data.full_name || data.fullName || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ü–∞—Å–ø–æ—Ä—Ç:</strong> ${data.passport_number || data.passportNumber || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>FCM —Ç–æ–∫–µ–Ω–æ–≤:</strong> ${data.fcmTokens ? data.fcmTokens.length : 0}</p>
                        ${data.fcmTokens && data.fcmTokens.length > 0 ? 
                            `<p><strong>–¢–æ–∫–µ–Ω—ã:</strong><br>${data.fcmTokens.map(t => t.substring(0, 50) + '...').join('<br>')}</p>` : ''}
                    `;
                    
                    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ userId
                    if (data.passport_number || data.passportNumber) {
                        document.getElementById('userId').value = data.passport_number || data.passportNumber;
                    }
                } else {
                    showResult('‚ùå –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    document.getElementById('tokenInfo').style.display = 'none';
                }
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`);
            }
        }

        async function sendNotification() {
            const title = document.getElementById('title').value;
            const message = document.getElementById('message').value;
            const userId = document.getElementById('userId').value.trim();

            if (!title || !message || !userId) {
                showResult('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }

            try {
                log('–°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Firestore...');
                
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ notifications
                const notificationRef = await db.collection('notifications').add({
                    userId: userId,
                    title: title,
                    message: message,
                    type: 'test',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isRead: false,
                    readAt: null
                });

                log(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —Å ID: ${notificationRef.id}`);
                showResult('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! Cloud Function –¥–æ–ª–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å push.', 'success');
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                setTimeout(async () => {
                    const doc = await notificationRef.get();
                    const data = doc.data();
                    
                    if (data.pushSent) {
                        log(`‚úÖ Push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –£—Å–ø–µ—à–Ω–æ: ${data.pushSuccessCount}, –û—à–∏–±–æ–∫: ${data.pushFailureCount}`);
                    } else if (data.pushError) {
                        log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ push: ${data.pushError}`);
                    } else {
                        log('‚è≥ Push –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...');
                    }
                }, 3000);
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html> 