<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Apartment Count</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .warning { background-color: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; }
        .apartment { margin: 5px 0; padding: 5px; background-color: #f8f9fa; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
    <h1>Debug Apartment Count</h1>
    <button onclick="checkApartmentCount()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä</button>
    <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    <div id="results"></div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBxGQoM3V-m6DtY9d_86Xsh8h5f0YZFU8Y",
            authDomain: "newport-resident.firebaseapp.com",
            projectId: "newport-resident",
            storageBucket: "newport-resident.appspot.com",
            messagingSenderId: "1098765432109",
            appId: "1:1098765432109:web:abcdef1234567890"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }

        function addApartment(apartment) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'apartment';
            div.innerHTML = `
                <strong>${apartment.blockId} ${apartment.apartmentNumber}</strong><br>
                ID: ${apartment.id}<br>
                Source: ${apartment.source}<br>
                Path: ${apartment.path}
            `;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function checkApartmentCount() {
            clearResults();
            addResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä –¥–ª—è –ø–∞—Å–ø–æ—Ä—Ç–∞: AD2444681', 'info');
            
            const passportNumber = 'AD2444681';
            const allApartments = [];
            const seenApartments = new Set();

            // Strategy 1: CollectionGroup search
            addResult('üìã Strategy 1: CollectionGroup search', 'info');
            try {
                const querySnapshot = await db.collectionGroup('apartments')
                    .where('passport_number', '==', passportNumber)
                    .get();

                addResult(`   –ù–∞–π–¥–µ–Ω–æ ${querySnapshot.docs.length} –∫–≤–∞—Ä—Ç–∏—Ä —á–µ—Ä–µ–∑ collectionGroup`, 'info');

                for (let doc of querySnapshot.docs) {
                    const data = doc.data();
                    const blockId = doc.ref.parent.parent?.id || 'Unknown';
                    const apartmentKey = `${blockId}_${data.apartment_number}`;
                    
                    if (!seenApartments.has(apartmentKey)) {
                        seenApartments.add(apartmentKey);
                        const apartment = {
                            blockId: blockId,
                            apartmentNumber: data.apartment_number,
                            id: doc.id,
                            path: doc.ref.path,
                            source: 'CollectionGroup'
                        };
                        allApartments.push(apartment);
                        addApartment(apartment);
                    } else {
                        addResult(`     ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: ${blockId} ${data.apartment_number}`, 'warning');
                    }
                }
            } catch (e) {
                addResult(`   ‚ùå CollectionGroup search failed: ${e.message}`, 'error');
            }

            // Strategy 2: Users collection search
            addResult('üìã Strategy 2: Users collection search', 'info');
            try {
                const usersSnapshot = await db.collection('users')
                    .where('passport_number', '==', passportNumber)
                    .get();

                addResult(`   –ù–∞–π–¥–µ–Ω–æ ${usersSnapshot.docs.length} –∫–≤–∞—Ä—Ç–∏—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users`, 'info');

                for (let doc of usersSnapshot.docs) {
                    const data = doc.data();
                    const blockNumber = data.block_number || 'Unknown';
                    const apartmentKey = `${blockNumber}_${data.apartment_number}`;
                    
                    if (!seenApartments.has(apartmentKey)) {
                        seenApartments.add(apartmentKey);
                        const apartment = {
                            blockId: blockNumber,
                            apartmentNumber: data.apartment_number,
                            id: doc.id,
                            path: doc.ref.path,
                            source: 'Users'
                        };
                        allApartments.push(apartment);
                        addApartment(apartment);
                    } else {
                        addResult(`     ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: ${blockNumber} ${data.apartment_number}`, 'warning');
                    }
                }
            } catch (e) {
                addResult(`   ‚ùå Users collection search failed: ${e.message}`, 'error');
            }

            // Strategy 3: Known blocks search
            addResult('üìã Strategy 3: Known blocks search', 'info');
            const knownBlocks = ['D BLOK', 'E BLOK', 'F BLOK', 'G BLOK', 'H BLOK', 'I BLOK', 'J BLOK'];
            
            for (let blockId of knownBlocks) {
                try {
                    const blockApartmentsSnapshot = await db.collection('users')
                        .doc(blockId)
                        .collection('apartments')
                        .where('passport_number', '==', passportNumber)
                        .get();

                    if (blockApartmentsSnapshot.docs.length > 0) {
                        addResult(`   –ë–ª–æ–∫ ${blockId}: –Ω–∞–π–¥–µ–Ω–æ ${blockApartmentsSnapshot.docs.length} –∫–≤–∞—Ä—Ç–∏—Ä`, 'info');

                        for (let doc of blockApartmentsSnapshot.docs) {
                            const data = doc.data();
                            const apartmentKey = `${blockId}_${data.apartment_number}`;
                            
                            if (!seenApartments.has(apartmentKey)) {
                                seenApartments.add(apartmentKey);
                                const apartment = {
                                    blockId: blockId,
                                    apartmentNumber: data.apartment_number,
                                    id: doc.id,
                                    path: doc.ref.path,
                                    source: 'KnownBlocks'
                                };
                                allApartments.push(apartment);
                                addApartment(apartment);
                            } else {
                                addResult(`     ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: ${blockId} ${data.apartment_number}`, 'warning');
                            }
                        }
                    }
                } catch (e) {
                    addResult(`   –ë–ª–æ–∫ ${blockId}: –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–∏—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è: ${e.message}`, 'info');
                }
            }

            // Final results
            addResult('üéØ === –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê ===', 'info');
            addResult(`   –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä –Ω–∞–π–¥–µ–Ω–æ: ${allApartments.length}`, 'success');
            
            if (allApartments.length === 0) {
                addResult('   ‚ùå –ö–≤–∞—Ä—Ç–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!', 'error');
            } else if (allApartments.length === 1) {
                addResult('   ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–∞ —Ç–æ–ª—å–∫–æ 1 –∫–≤–∞—Ä—Ç–∏—Ä–∞', 'warning');
            } else {
                addResult(`   ‚úÖ –ù–∞–π–¥–µ–Ω–æ ${allApartments.length} –∫–≤–∞—Ä—Ç–∏—Ä - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!`, 'success');
            }
        }
    </script>
</body>
</html> 