<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤ –≤ Firestore</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0050A3;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #0050A3;
        }
        button {
            background: #0050A3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        button:hover {
            background: #003d82;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .preset-btn {
            background: #28a745;
            margin: 5px;
            padding: 8px 16px;
            width: auto;
            display: inline-block;
        }
        .preset-btn:hover {
            background: #218838;
        }
        .preset-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤ –≤ Firestore</h1>
        
        <div class="preset-section">
            <h3>üéØ –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:</h3>
            <button class="preset-btn" onclick="checkPreset('all')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ FCM —Ç–æ–∫–µ–Ω—ã</button>
            <button class="preset-btn" onclick="checkPreset('apartments')">FCM –≤ –∫–≤–∞—Ä—Ç–∏—Ä–∞—Ö</button>
            <button class="preset-btn" onclick="checkPreset('fcm_collection')">FCM –∫–æ–ª–ª–µ–∫—Ü–∏—è</button>
            <button class="preset-btn" onclick="checkPreset('users_collection')">FCM –≤ users</button>
        </div>

        <div class="form-group">
            <label for="checkType">–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
            <select id="checkType">
                <option value="apartment">–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</option>
                <option value="phone">–ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</option>
                <option value="passport">–ü–æ –Ω–æ–º–µ—Ä—É –ø–∞—Å–ø–æ—Ä—Ç–∞</option>
                <option value="all_blocks">–í—Å–µ –±–ª–æ–∫–∏</option>
                <option value="fcm_tokens">FCM –∫–æ–ª–ª–µ–∫—Ü–∏—è</option>
            </select>
        </div>

        <div class="form-group" id="blockGroup">
            <label for="blockId">ID –±–ª–æ–∫–∞:</label>
            <input type="text" id="blockId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BLOK A" value="BLOK A">
        </div>

        <div class="form-group" id="apartmentGroup">
            <label for="apartmentNumber">–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã:</label>
            <input type="text" id="apartmentNumber" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 101" value="101">
        </div>

        <div class="form-group" id="phoneGroup" style="display: none;">
            <label for="phoneNumber">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
            <input type="text" id="phoneNumber" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: +998900000101" value="+998900000101">
        </div>

        <div class="form-group" id="passportGroup" style="display: none;">
            <label for="passportNumber">–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞:</label>
            <input type="text" id="passportNumber" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AB1234567">
        </div>

        <button onclick="checkFCMTokens()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FCM —Ç–æ–∫–µ–Ω—ã</button>

        <div id="result"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, query, limit } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA5Z_0G2G0kZvF4F0Av_dZRxXNRPPEQ6zM",
            authDomain: "newport-resident.firebaseapp.com",
            projectId: "newport-resident",
            storageBucket: "newport-resident.firebasestorage.app",
            messagingSenderId: "1021151849001",
            appId: "1:1021151849001:web:eb77b2c0d8d9db78eb5a30",
            measurementId: "G-4DVZWSP5MY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
        document.getElementById('checkType').addEventListener('change', function() {
            const type = this.value;
            
            document.getElementById('blockGroup').style.display = 
                (type === 'apartment') ? 'block' : 'none';
            document.getElementById('apartmentGroup').style.display = 
                (type === 'apartment') ? 'block' : 'none';
            document.getElementById('phoneGroup').style.display = 
                (type === 'phone') ? 'block' : 'none';
            document.getElementById('passportGroup').style.display = 
                (type === 'passport') ? 'block' : 'none';
        });

        window.checkPreset = function(preset) {
            const checkType = document.getElementById('checkType');
            const blockId = document.getElementById('blockId');
            const apartmentNumber = document.getElementById('apartmentNumber');
            
            switch(preset) {
                case 'all':
                    checkType.value = 'all_blocks';
                    break;
                case 'apartments':
                    checkType.value = 'apartment';
                    blockId.value = 'BLOK A';
                    apartmentNumber.value = '101';
                    break;
                case 'fcm_collection':
                    checkType.value = 'fcm_tokens';
                    break;
                case 'users_collection':
                    checkType.value = 'passport';
                    break;
            }
            
            // Trigger change event
            checkType.dispatchEvent(new Event('change'));
            
            // Run check
            setTimeout(() => checkFCMTokens(), 100);
        };

        window.checkFCMTokens = async function() {
            const resultDiv = document.getElementById('result');
            const button = document.querySelector('button[onclick="checkFCMTokens()"]');
            
            button.disabled = true;
            button.textContent = 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            
            try {
                const checkType = document.getElementById('checkType').value;
                let result = '';

                switch(checkType) {
                    case 'apartment':
                        result = await checkApartmentFCM();
                        break;
                    case 'phone':
                        result = await checkPhoneFCM();
                        break;
                    case 'passport':
                        result = await checkPassportFCM();
                        break;
                    case 'all_blocks':
                        result = await checkAllBlocksFCM();
                        break;
                    case 'fcm_tokens':
                        result = await checkFCMCollection();
                        break;
                }

                resultDiv.className = 'result success';
                resultDiv.textContent = result;

            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            } finally {
                button.disabled = false;
                button.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FCM —Ç–æ–∫–µ–Ω—ã';
            }
        };

        async function checkApartmentFCM() {
            const blockId = document.getElementById('blockId').value.trim();
            const apartmentNumber = document.getElementById('apartmentNumber').value.trim();
            
            if (!blockId || !apartmentNumber) {
                throw new Error('–£–∫–∞–∂–∏—Ç–µ –±–ª–æ–∫ –∏ –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã');
            }

            const docRef = doc(db, 'users', blockId, 'apartments', apartmentNumber);
            const docSnap = await getDoc(docRef);
            
            let result = `üè† –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã: ${blockId}/${apartmentNumber}\n\n`;
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                const pushToken = data.pushToken;
                const fcmTokens = data.fcmTokens;
                
                result += `‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã –Ω–∞–π–¥–µ–Ω\n`;
                result += `üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π: ${Object.keys(data).length}\n\n`;
                
                result += `üì± FCM —Å—Ç–∞—Ç—É—Å:\n`;
                result += `   pushToken: ${pushToken ? '‚úÖ –ï–°–¢–¨' : '‚ùå –ù–ï–¢'}\n`;
                if (pushToken) {
                    result += `   pushToken –¥–ª–∏–Ω–∞: ${pushToken.length}\n`;
                    result += `   pushToken –Ω–∞—á–∞–ª–æ: ${pushToken.substring(0, 50)}...\n`;
                }
                
                result += `   fcmTokens: ${fcmTokens ? `‚úÖ –ï–°–¢–¨ (${fcmTokens.length} —Ç–æ–∫–µ–Ω–æ–≤)` : '‚ùå –ù–ï–¢'}\n`;
                if (fcmTokens && fcmTokens.length > 0) {
                    fcmTokens.forEach((token, i) => {
                        result += `   —Ç–æ–∫–µ–Ω ${i+1}: ${token.substring(0, 50)}...\n`;
                    });
                }
                
                result += `\nüìã –î—Ä—É–≥–∏–µ –ø–æ–ª—è:\n`;
                Object.keys(data).forEach(key => {
                    if (key !== 'pushToken' && key !== 'fcmTokens') {
                        const value = data[key];
                        result += `   ${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}\n`;
                    }
                });
                
            } else {
                result += `‚ùå –î–æ–∫—É–º–µ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã –ù–ï –ù–ê–ô–î–ï–ù\n`;
                result += `   –ü—É—Ç—å: users/${blockId}/apartments/${apartmentNumber}\n\n`;
                
                // –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –µ—Å—Ç—å –≤ –±–ª–æ–∫–µ
                try {
                    const blockRef = doc(db, 'users', blockId);
                    const blockSnap = await getDoc(blockRef);
                    
                    if (blockSnap.exists()) {
                        result += `üèóÔ∏è –ë–ª–æ–∫ "${blockId}" —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n`;
                        
                        // –ü—Ä–æ–≤–µ—Ä–∏–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –±–ª–æ–∫–µ
                        const apartmentsRef = collection(db, 'users', blockId, 'apartments');
                        const apartmentsSnap = await getDocs(query(apartmentsRef, limit(20)));
                        
                        if (!apartmentsSnap.empty) {
                            const apartmentIds = apartmentsSnap.docs.map(doc => doc.id);
                            result += `üìã –ö–≤–∞—Ä—Ç–∏—Ä—ã –≤ –±–ª–æ–∫–µ: ${apartmentIds.join(', ')}\n`;
                            result += `‚ùå –ö–≤–∞—Ä—Ç–∏—Ä–∞ "${apartmentNumber}" –ù–ï –ù–ê–ô–î–ï–ù–ê —Å—Ä–µ–¥–∏: ${apartmentIds.join(', ')}\n`;
                        } else {
                            result += `‚ùå –í –±–ª–æ–∫–µ –ù–ï–¢ –∫–≤–∞—Ä—Ç–∏—Ä\n`;
                        }
                    } else {
                        result += `‚ùå –ë–ª–æ–∫ "${blockId}" –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢\n`;
                    }
                } catch (e) {
                    result += `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–ª–æ–∫–∞: ${e.message}\n`;
                }
            }
            
            return result;
        }

        async function checkPhoneFCM() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            if (!phoneNumber) {
                throw new Error('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            }
            
            const normalizedPhone = phoneNumber.replace(/[^0-9]/g, '');
            const docRef = doc(db, 'fcm_tokens', normalizedPhone);
            const docSnap = await getDoc(docRef);
            
            let result = `üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: ${phoneNumber}\n`;
            result += `üîç –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: ${normalizedPhone}\n\n`;
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                result += `‚úÖ FCM –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω\n`;
                result += `üìä –î–∞–Ω–Ω—ã–µ:\n`;
                Object.keys(data).forEach(key => {
                    const value = data[key];
                    if (key === 'tokens' && Array.isArray(value)) {
                        result += `   ${key}: ${value.length} —Ç–æ–∫–µ–Ω–æ–≤\n`;
                        value.forEach((token, i) => {
                            result += `     —Ç–æ–∫–µ–Ω ${i+1}: ${token.substring(0, 50)}...\n`;
                        });
                    } else {
                        result += `   ${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}\n`;
                    }
                });
            } else {
                result += `‚ùå FCM –¥–æ–∫—É–º–µ–Ω—Ç –ù–ï –ù–ê–ô–î–ï–ù –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ fcm_tokens\n`;
            }
            
            return result;
        }

        async function checkPassportFCM() {
            const passportNumber = document.getElementById('passportNumber').value.trim();
            if (!passportNumber) {
                throw new Error('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞');
            }
            
            const docRef = doc(db, 'users', passportNumber);
            const docSnap = await getDoc(docRef);
            
            let result = `üÜî –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É: ${passportNumber}\n\n`;
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                result += `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω\n`;
                result += `üìä –î–∞–Ω–Ω—ã–µ:\n`;
                Object.keys(data).forEach(key => {
                    const value = data[key];
                    if (key === 'fcmTokens' && Array.isArray(value)) {
                        result += `   ${key}: ${value.length} —Ç–æ–∫–µ–Ω–æ–≤\n`;
                        value.forEach((token, i) => {
                            result += `     —Ç–æ–∫–µ–Ω ${i+1}: ${token.substring(0, 50)}...\n`;
                        });
                    } else {
                        result += `   ${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}\n`;
                    }
                });
            } else {
                result += `‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ù–ê–ô–î–ï–ù –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users\n`;
            }
            
            return result;
        }

        async function checkAllBlocksFCM() {
            const usersRef = collection(db, 'users');
            const usersSnap = await getDocs(query(usersRef, limit(50)));
            
            let result = `üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤ –≤–æ –≤—Å–µ—Ö –±–ª–æ–∫–∞—Ö\n\n`;
            let totalApartments = 0;
            let apartmentsWithFCM = 0;
            
            for (const blockDoc of usersSnap.docs) {
                const blockId = blockDoc.id;
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ –±–ª–æ–∫–∏)
                if (blockId.length > 10 || !blockId.includes('BLOK')) {
                    continue;
                }
                
                result += `üè† –ë–ª–æ–∫: ${blockId}\n`;
                
                try {
                    const apartmentsRef = collection(db, 'users', blockId, 'apartments');
                    const apartmentsSnap = await getDocs(apartmentsRef);
                    
                    if (!apartmentsSnap.empty) {
                        for (const aptDoc of apartmentsSnap.docs) {
                            totalApartments++;
                            const data = aptDoc.data();
                            const hasPushToken = !!data.pushToken;
                            const hasFcmTokens = data.fcmTokens && data.fcmTokens.length > 0;
                            
                            if (hasPushToken || hasFcmTokens) {
                                apartmentsWithFCM++;
                                result += `  üì± ${aptDoc.id}: `;
                                if (hasPushToken) result += `pushToken ‚úÖ `;
                                if (hasFcmTokens) result += `fcmTokens(${data.fcmTokens.length}) ‚úÖ`;
                                result += `\n`;
                            } else {
                                result += `  ‚ùå ${aptDoc.id}: –Ω–µ—Ç FCM —Ç–æ–∫–µ–Ω–æ–≤\n`;
                            }
                        }
                    } else {
                        result += `  üîç –ö–≤–∞—Ä—Ç–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\n`;
                    }
                } catch (e) {
                    result += `  ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
                }
                
                result += `\n`;
            }
            
            result += `üìä –ò–¢–û–ì–û:\n`;
            result += `   –í—Å–µ–≥–æ –∫–≤–∞—Ä—Ç–∏—Ä: ${totalApartments}\n`;
            result += `   –° FCM —Ç–æ–∫–µ–Ω–∞–º–∏: ${apartmentsWithFCM}\n`;
            result += `   –ü—Ä–æ—Ü–µ–Ω—Ç: ${totalApartments > 0 ? Math.round(apartmentsWithFCM / totalApartments * 100) : 0}%\n`;
            
            return result;
        }

        async function checkFCMCollection() {
            const fcmRef = collection(db, 'fcm_tokens');
            const fcmSnap = await getDocs(query(fcmRef, limit(50)));
            
            let result = `üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ fcm_tokens\n\n`;
            
            if (!fcmSnap.empty) {
                result += `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${fcmSnap.docs.length} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n\n`;
                
                fcmSnap.docs.forEach(doc => {
                    const data = doc.data();
                    result += `üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${doc.id}\n`;
                    result += `   –¢–æ–∫–µ–Ω–æ–≤: ${data.tokens ? data.tokens.length : 0}\n`;
                    result += `   –ë–ª–æ–∫: ${data.blockId || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n`;
                    result += `   –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${data.apartmentNumber || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n`;
                    result += `   –ò–º—è: ${data.fullName || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n`;
                    if (data.tokens && data.tokens.length > 0) {
                        data.tokens.forEach((token, i) => {
                            result += `     —Ç–æ–∫–µ–Ω ${i+1}: ${token.substring(0, 50)}...\n`;
                        });
                    }
                    result += `\n`;
                });
            } else {
                result += `‚ùå –ö–æ–ª–ª–µ–∫—Ü–∏—è fcm_tokens –ü–£–°–¢–ê\n`;
                result += `üí° FCM —Ç–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏–∑-–∑–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫\n`;
            }
            
            return result;
        }
    </script>
</body>
</html> 