rules_version = '2';

// üîê –ë–ï–ó–û–ü–ê–°–ù–´–ï –ü–†–ê–í–ò–õ–ê FIREBASE STORAGE
service firebase.storage {
  match /b/{bucket}/o {
    
    // ===== HELPER –§–£–ù–ö–¶–ò–ò =====
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    function isAdmin() {
      return isAuthenticated() && 
        firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function isValidImage() {
      return request.resource != null &&
             request.resource.contentType != null &&
             request.resource.contentType.matches('image/.*') &&
             request.resource.size < 10 * 1024 * 1024; // 10MB
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    function isValidDocument() {
      return request.resource != null &&
             request.resource.contentType != null &&
             (request.resource.contentType.matches('application/pdf') ||
              request.resource.contentType.matches('image/.*')) &&
             request.resource.size < 15 * 1024 * 1024; // 15MB
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–∞
    function ownsUtilityReading(readingId) {
      return isAuthenticated() && 
        firestore.get(/databases/(default)/documents/utilityReadings/$(readingId)).data.userId == request.auth.uid;
    }
    
    // ===== –ü–†–ê–í–ò–õ–ê –î–õ–Ø –ü–£–¢–ï–ô =====
    
    // üì± –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–ï–†–í–ò–°–ù–´–• –ó–ê–Ø–í–û–ö
    // –ü—É—Ç—å: service_requests/{requestId}/images/{imageId}
    match /service_requests/{requestId}/images/{imageId} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ
      allow read: if true;
      
      // –ó–∞–ø–∏—Å—å –¥–ª—è –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö)
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—è–≤–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      allow create: if isAuthenticated() && isValidImage() && (
        // –†–∞–∑—Ä–µ—à–∞–µ–º –µ—Å–ª–∏ –∑–∞—è–≤–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏)
        !firestore.exists(/databases/(default)/documents/serviceRequests/$(requestId)) ||
        // –ò–ª–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–µ—Ç –∑–∞—è–≤–∫–æ–π
        firestore.get(/databases/(default)/documents/serviceRequests/$(requestId)).data.userId == request.auth.uid
      );
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø—Ä–µ—â–µ–Ω–æ (–∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å)
      allow update: if false;
      
      // –£–¥–∞–ª–µ–Ω–∏–µ: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–ª–∏ –∞–¥–º–∏–Ω
      allow delete: if isAuthenticated() || isAdmin();
    }
    
    // üë§ –ü–†–û–§–ò–õ–¨–ù–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
    // –ü—É—Ç—å: users/{userId}/profile/{imageId}
    match /users/{userId}/profile/{imageId} {
      // –ß—Ç–µ–Ω–∏–µ: –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –∞–¥–º–∏–Ω
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
      
      // –ó–∞–ø–∏—Å—å: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ñ–∏–ª—è, —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      allow create: if isAuthenticated() && 
        request.auth.uid == userId && 
        isValidImage();
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø—Ä–µ—â–µ–Ω–æ
      allow update: if false;
      
      // –£–¥–∞–ª–µ–Ω–∏–µ: –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –∞–¥–º–∏–Ω
      allow delete: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
    }
    
    // üìä –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–û–ö–ê–ó–ê–ù–ò–ô –°–ß–ï–¢–ß–ò–ö–û–í
    // –ü—É—Ç—å: utility_readings/{readingId}/images/{imageId}
    match /utility_readings/{readingId}/images/{imageId} {
      // –ß—Ç–µ–Ω–∏–µ: –≤–ª–∞–¥–µ–ª–µ—Ü –ø–æ–∫–∞–∑–∞–Ω–∏—è –∏–ª–∏ –∞–¥–º–∏–Ω
      allow read: if ownsUtilityReading(readingId) || isAdmin();
      
      // –ó–∞–ø–∏—Å—å: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –ø–æ–∫–∞–∑–∞–Ω–∏—è, —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      allow create: if ownsUtilityReading(readingId) && isValidImage();
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø—Ä–µ—â–µ–Ω–æ
      allow update: if false;
      
      // –£–¥–∞–ª–µ–Ω–∏–µ: –≤–ª–∞–¥–µ–ª–µ—Ü –ø–æ–∫–∞–∑–∞–Ω–∏—è –∏–ª–∏ –∞–¥–º–∏–Ω
      allow delete: if ownsUtilityReading(readingId) || isAdmin();
    }
    
    // üì∞ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ô –ö–û–ù–¢–ï–ù–¢ (–Ω–æ–≤–æ—Å—Ç–∏, –æ–±—ä—è–≤–ª–µ–Ω–∏—è)
    // –ü—É—Ç—å: admin/news/{newsId}/{fileName}
    match /admin/news/{newsId}/{fileName} {
      // –ß—Ç–µ–Ω–∏–µ: –ø—É–±–ª–∏—á–Ω–æ–µ (–¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π)
      allow read: if true;
      
      // –ó–∞–ø–∏—Å—å: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
      allow create, update: if isAdmin() && isValidDocument();
      
      // –£–¥–∞–ª–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
      allow delete: if isAdmin();
    }
    
    // üìÅ –í–†–ï–ú–ï–ù–ù–´–ï –ó–ê–ì–†–£–ó–ö–ò
    // –ü—É—Ç—å: temp/{userId}/{fileName}
    match /temp/{userId}/{fileName} {
      // –ß—Ç–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // –°–æ–∑–¥–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
      allow create: if isAuthenticated() && 
        request.auth.uid == userId &&
        request.resource.size < 20 * 1024 * 1024; // 20MB
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø—Ä–µ—â–µ–Ω–æ
      allow update: if false;
      
      // –£–¥–∞–ª–µ–Ω–∏–µ: –≤–ª–∞–¥–µ–ª–µ—Ü (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏)
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // üìÑ –î–û–ö–£–ú–ï–ù–¢–´ –ö–í–ê–†–¢–ò–† (–¥–æ–≥–æ–≤–æ—Ä—ã, –∞–∫—Ç—ã)
    // –ü—É—Ç—å: apartments/{apartmentId}/documents/{documentId}
    match /apartments/{apartmentId}/documents/{documentId} {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–≤–∞—Ä—Ç–∏—Ä–µ
      function hasApartmentAccess() {
        let apartment = firestore.get(/databases/(default)/documents/apartments/$(apartmentId));
        return apartment.data.ownerId == request.auth.uid ||
               request.auth.uid in apartment.data.familyMemberIds;
      }
      
      // –ß—Ç–µ–Ω–∏–µ: –≤–ª–∞–¥–µ–ª–µ—Ü, —á–ª–µ–Ω—ã —Å–µ–º—å–∏ –∏–ª–∏ –∞–¥–º–∏–Ω
      allow read: if isAuthenticated() && 
        (hasApartmentAccess() || isAdmin());
      
      // –°–æ–∑–¥–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã)
      allow create: if isAdmin() && isValidDocument();
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø—Ä–µ—â–µ–Ω–æ
      allow update: if false;
      
      // –£–¥–∞–ª–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
      allow delete: if isAdmin();
    }
    
    // üè¢ –î–û–ö–£–ú–ï–ù–¢–´ –ö–û–ú–ü–ê–ù–ò–ò (–ø—É–±–ª–∏—á–Ω—ã–µ)
    // –ü—É—Ç—å: public/documents/{documentId}
    match /public/documents/{documentId} {
      // –ß—Ç–µ–Ω–∏–µ: –ø—É–±–ª–∏—á–Ω–æ–µ
      allow read: if true;
      
      // –ó–∞–ø–∏—Å—å: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
      allow write: if isAdmin() && isValidDocument();
    }
    
    // ===== –ó–ê–©–ò–¢–ê –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ =====
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
