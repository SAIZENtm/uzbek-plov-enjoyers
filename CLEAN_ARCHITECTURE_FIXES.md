# üßπ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞**

–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `users` —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, —á—Ç–æ –∑–∞—Å–æ—Ä—è–ª–æ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

```json
{
  "apartmentNumber": "101",
  "blockId": "D BLOK BLOK",
  "createdAt": "July 19, 2025 at 7:35:47 PM UTC+5",
  "fullName": "AFINA ALIYEVA TURSUNJONOVNA",
  "lastLogin": "July 19, 2025 at 7:35:47 PM UTC+5",
  "phone": "+998988124111",
  "role": "owner",
  "uid": "t766cgN6G9QLMD0KdnhomhWwfpK2"
}
```

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ**

### 1. **–†–∞–∑–¥–µ–ª–∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é:**

#### **`users` - —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
- –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è

#### **`userProfiles` - –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–≤–∞—Ä—Ç–∏—Ä–∞
- –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- FCM —Ç–æ–∫–µ–Ω—ã
- –î–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

#### **Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
- ‚úÖ `lib/core/services/auth_service.dart` - –º–µ—Ç–æ–¥ `_saveUserDataToFirestore`
- ‚úÖ `lib/core/services/fcm_service.dart` - –º–µ—Ç–æ–¥ `_saveTokenToFirestore`  
- ‚úÖ `lib/core/services/family_request_service.dart` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–º–µ–π–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `firestore.rules` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è `userProfiles`

#### **Cloud Functions:**
- ‚úÖ `functions/inviteFunctions.js` - —Ñ—É–Ω–∫—Ü–∏–∏ `getUserRole` –∏ `acceptFamilyInvite`

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore:**

```javascript
// –ö–û–õ–õ–ï–ö–¶–ò–Ø USERS - –¢–û–õ–¨–ö–û –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
// (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –æ–Ω –ø—Ä–æ—á–∏—Ç–∞–ª, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
match /users/{userId} {
  allow read, write: if isAuthenticated();
}

// –ö–û–õ–õ–ï–ö–¶–ò–Ø USER PROFILES - –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// (–§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–≤–∞—Ä—Ç–∏—Ä–∞, —Ä–æ–ª—å –∏ —Ç.–¥.)
match /userProfiles/{profileId} {
  allow read, write: if isAuthenticated();
}
```

## üóÇÔ∏è **–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

### **–ö–æ–ª–ª–µ–∫—Ü–∏—è `users` (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):**
```
users/{userId}
‚îú‚îÄ‚îÄ metadata/
‚îÇ   ‚îî‚îÄ‚îÄ readNewsIds: [array]
‚îú‚îÄ‚îÄ preferences/
‚îÇ   ‚îú‚îÄ‚îÄ notifications: {object}
‚îÇ   ‚îî‚îÄ‚îÄ language: string
‚îî‚îÄ‚îÄ settings: {object}
```

### **–ö–æ–ª–ª–µ–∫—Ü–∏—è `userProfiles` (–ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):**
```
userProfiles/{profileId}
‚îú‚îÄ‚îÄ uid: string
‚îú‚îÄ‚îÄ fullName: string
‚îú‚îÄ‚îÄ phone: string
‚îú‚îÄ‚îÄ role: string
‚îú‚îÄ‚îÄ apartmentNumber: string
‚îú‚îÄ‚îÄ blockId: string
‚îú‚îÄ‚îÄ fcmTokens: [array]
‚îú‚îÄ‚îÄ lastLogin: timestamp
‚îú‚îÄ‚îÄ createdAt: timestamp
‚îî‚îÄ‚îÄ dataSource: string
```

### **–ö–æ–ª–ª–µ–∫—Ü–∏—è `users/{blockId}/apartments/{apartmentNumber}` (–¥–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä):**
```
users/{blockId}/apartments/{apartmentNumber}
‚îú‚îÄ‚îÄ apartment_number: string
‚îú‚îÄ‚îÄ phone: string
‚îú‚îÄ‚îÄ passport_number: string
‚îú‚îÄ‚îÄ fullName: string
‚îú‚îÄ‚îÄ fcmTokens: [array]
‚îú‚îÄ‚îÄ pushToken: string
‚îî‚îÄ‚îÄ lastTokenUpdate: timestamp
```

## üöÄ **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

### 1. **–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Firestore:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ [Firebase Console](https://console.firebase.google.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç `newport-23a19`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Firestore Database ‚Üí Rules**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Ñ–∞–π–ª–∞ `firestore.rules`
5. –ù–∞–∂–º–∏—Ç–µ **"Publish"**

### 2. **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å Cloud Functions:**
```bash
cd functions
npm install
firebase deploy --only functions
```

### 3. **–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –í Firebase Console –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –º—É—Å–æ—Ä–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `users`
- –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîç **–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### 1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firebase Console:**
- –ö–æ–ª–ª–µ–∫—Ü–∏—è `users` –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ö–æ–ª–ª–µ–∫—Ü–∏—è `userProfiles` –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
```
Firebase Auth: User profile saved to userProfiles collection
‚úÖ User profile saved to userProfiles collection successfully!
```

### 3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**
- –í–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `userProfiles`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `users`

## üí° **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

### ‚úÖ **–ß–∏—Å—Ç–æ—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
- –ù–µ—Ç –º—É—Å–æ—Ä–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `users`
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é

### ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –†–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∞–≤

### ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –õ–µ–≥—á–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ—â–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å

### ‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:**
- –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ß–µ—Ç–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏

## üîß **–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:**

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `users`
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —á—Ç–æ –Ω–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ `userProfiles`

### **–û—á–∏—Å—Ç–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞):**
```javascript
// –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –º—É—Å–æ—Ä–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
// (–∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
const usersRef = firebase.firestore().collection('users');
const batch = firebase.firestore().batch();

usersRef.where('fullName', '!=', null).get().then(snapshot => {
  snapshot.forEach(doc => {
    const data = doc.data();
    // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —É–¥–∞–ª—è–µ–º
    if (data.fullName && data.phone && data.apartmentNumber) {
      batch.delete(doc.ref);
    }
  });
  return batch.commit();
});
```

---

## üéâ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

**–¢–µ–ø–µ—Ä—å –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —á–∏—Å—Ç–∞—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è!**

- ‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è `users` - —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è `userProfiles` - —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–∏  
- ‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è `users/{block}/apartments/{apt}` - —Ç–æ–ª—å–∫–æ –∫–≤–∞—Ä—Ç–∏—Ä—ã
- ‚úÖ –ß–µ—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ 