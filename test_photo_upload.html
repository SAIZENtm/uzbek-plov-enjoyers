<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 { color: #2d3748; margin-bottom: 30px; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .success { background: #c6f6d5; color: #2f855a; }
        .error { background: #fed7d7; color: #c53030; }
        .info { background: #bee3f8; color: #2b6cb0; }
        .warning { background: #faf089; color: #975a16; }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover { border-color: #4299e1; background: #f7fafc; }
        .upload-area.dragover { border-color: #3182ce; background: #ebf8ff; }
        input[type="file"] { display: none; }
        button {
            background: #4299e1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #3182ce; }
        button:disabled { background: #a0aec0; cursor: not-allowed; }
        .progress { 
            width: 100%; 
            height: 4px; 
            background: #e2e8f0; 
            border-radius: 2px; 
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar { 
            height: 100%; 
            background: #4299e1; 
            width: 0%; 
            transition: width 0.3s ease;
        }
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .auth-info {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ Firebase Storage</h1>
        
        <div id="authStatus" class="info">
            üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...
        </div>

        <div class="auth-info">
            <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
            <ul>
                <li>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞–ø—Ä—è–º—É—é –≤ Firebase Storage</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–∫–∞–∫ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)</li>
                <li>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ –ø—É—Ç–∏ <code>service_requests/{requestId}/images/</code></li>
            </ul>
        </div>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            üì∏ –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å—é–¥–∞<br>
            <small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG, –¥–æ 10MB</small>
        </div>
        
        <input type="file" id="fileInput" accept="image/*" multiple>
        
        <div class="progress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="previewContainer"></div>

        <div id="results"></div>

        <div class="log" id="logContainer">
            –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
        </div>

        <button onclick="testRules()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Storage</button>
        <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é)
        const firebaseConfig = {
            apiKey: "AIzaSyDVy8OhKiDW8CPOJ2yUnx-ov5WkOYa8WMg",
            authDomain: "newport-23a19.firebaseapp.com",
            projectId: "newport-23a19",
            storageBucket: "newport-23a19.firebasestorage.app",
            messagingSenderId: "254421846823",
            appId: "1:254421846823:web:8f1742dfd38b0b38bce866"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentUser = null;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–æ–≥–∞
        window.log = function(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#4299e1',
                'success': '#48bb78',
                'error': '#f56565',
                'warning': '#ed8936'
            };
            
            logContainer.innerHTML += `<div style="color: ${colorMap[type]};">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        };

        window.clearLog = function() {
            document.getElementById('logContainer').innerHTML = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...';
        };

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authStatus = document.getElementById('authStatus');
            
            if (user) {
                authStatus.className = 'status success';
                authStatus.innerHTML = `‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∞–Ω–æ–Ω–∏–º–Ω–æ: ${user.uid}`;
                log(`–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∫–∞–∫: ${user.uid}`, 'success');
            } else {
                authStatus.className = 'status warning';
                authStatus.innerHTML = 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...';
                
                signInAnonymously(auth)
                    .then(() => {
                        log('–ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'success');
                    })
                    .catch((error) => {
                        authStatus.className = 'status error';
                        authStatus.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`;
                        log(`–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`, 'error');
                    });
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        document.getElementById('fileInput').addEventListener('change', handleFiles);
        
        // Drag & Drop
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFileList(files);
        });

        function handleFiles(event) {
            const files = Array.from(event.target.files);
            handleFileList(files);
        }

        function handleFileList(files) {
            if (!currentUser) {
                log('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }

            files.forEach((file, index) => {
                uploadFile(file, index);
            });
        }

        function uploadFile(file, index) {
            log(`–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
            if (file.size > 10 * 1024 * 1024) {
                log(`–û—à–∏–±–∫–∞: —Ñ–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (> 10MB)`, 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                log(`–û—à–∏–±–∫–∞: ${file.name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`, 'error');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            showPreview(file);

            // –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            const requestId = Date.now().toString();
            const fileName = `image_${index + 1}_${requestId}.${file.name.split('.').pop()}`;
            const storagePath = `service_requests/${requestId}/images/${fileName}`;
            
            log(`–ü—É—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏: ${storagePath}`, 'info');

            // –°–æ–∑–¥–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progressContainer = document.querySelector('.progress');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                    log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${file.name}: ${progress.toFixed(1)}%`, 'info');
                },
                (error) => {
                    progressContainer.style.display = 'none';
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${error.message}`, 'error');
                    
                    // –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
                    if (error.code) {
                        log(`–ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code}`, 'error');
                    }
                    
                    showResult(`‚ùå ${file.name}: ${error.message}`, 'error');
                },
                () => {
                    progressContainer.style.display = 'none';
                    
                    getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                        log(`‚úÖ ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!`, 'success');
                        log(`URL: ${downloadURL}`, 'success');
                        showResult(`‚úÖ ${file.name}: –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'success');
                    });
                }
            );
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById('previewContainer');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-preview';
                img.alt = file.name;
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }

        function showResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }

        // –¢–µ—Å—Ç –ø—Ä–∞–≤–∏–ª
        window.testRules = async function() {
            if (!currentUser) {
                log('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }

            log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª–∞ Storage...', 'info');
            
            try {
                // –¢–µ—Å—Ç 1: –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
                const testRef = ref(storage, 'service_requests/test/images/test.jpg');
                
                try {
                    await getDownloadURL(testRef);
                    log('‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ: —Å–º–æ–≥–ª–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª', 'error');
                } catch (error) {
                    if (error.code === 'storage/object-not-found') {
                        log('‚úÖ –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)', 'success');
                    } else {
                        log(`‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}`, 'warning');
                    }
                }

                log('–ü—Ä–∞–≤–∏–ª–∞ Storage –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html> 