# üî• –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Firestore Rules –¥–ª—è –£–º–Ω–æ–≥–æ –î–æ–º–∞

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

–ü—Ä–∞–≤–∏–ª–∞ Firestore —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —É–º–Ω–æ–≥–æ –¥–æ–º–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏—Ö –≤ Firebase Console.

## üöÄ –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å Firebase Console
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [Firebase Console](https://console.firebase.google.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç **newport-23a19**

### –®–∞–≥ 2: –ü–µ—Ä–µ–π—Ç–∏ –∫ Firestore Database
1. –í –ª–µ–≤–æ–º –º–µ–Ω—é –Ω–∞–∂–º–∏—Ç–µ **"Firestore Database"**
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **"Rules"**

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–í–°–ï —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ** —Ñ–∞–π–ª–∞ `firestore.rules`
2. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª, –∑–∞–º–µ–Ω–∏–≤ —Å—Ç–∞—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞
3. –ù–∞–∂–º–∏—Ç–µ **"Publish"**

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
1. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è "Rules published successfully"
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã

## üîê –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö

### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —É–º–Ω–æ–≥–æ –¥–æ–º–∞:
```javascript
// –£–º–Ω—ã–π –¥–æ–º - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–æ–π
function canAccessSmartHome() {
  return isAuthenticated() && (
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ
    exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) ||
    resource != null
  );
}

// –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è smartHome –¥–∞–Ω–Ω—ã—Ö
allow update: if canAccessSmartHome() && 
  request.resource.data.keys().hasOnly(['name', 'phone', 'fcmToken', 'smartHome', 'lastActivity']) &&
  (request.resource.data.smartHome == null || 
   request.resource.data.smartHome is map);
```

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å **—Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–æ–π**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Firebase Auth
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö smartHome
- –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ–ª—è: `name`, `phone`, `fcmToken`, `smartHome`, `lastActivity`

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —É–º–Ω–æ–≥–æ –¥–æ–º–∞

```json
{
  "users": {
    "H BLOK": {
      "apartments": {
        "102": {
          "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
          "phone": "+998...",
          "smartHome": {
            "devices": [
              {
                "id": "light_1234567890",
                "name": "–õ—é—Å—Ç—Ä–∞ –≤ –∑–∞–ª–µ", 
                "type": "light",
                "status": "off",
                "lastUpdated": "2024-01-15T10:30:00Z",
                "updatedBy": "User Name"
              }
            ],
            "lastSyncTime": "2024-01-15T10:30:00Z",
            "isEnabled": true
          }
        }
      }
    }
  }
}
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–£–º–Ω—ã–π –¥–æ–º"**
3. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ**
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Firestore**

## üö® –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –û—à–∏–±–∫–∞ "Permission denied"
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –≤ smartHome

### –û—à–∏–±–∫–∞ "Invalid data"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ smartHome —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ–ª—è

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Firebase Console
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø—Ä–∞–≤–∏–ª
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

**‚úÖ –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —à–∞–≥–∞ –º–æ–¥—É–ª—å —É–º–Ω–æ–≥–æ –¥–æ–º–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** 