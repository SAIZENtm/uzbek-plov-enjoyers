<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Newport</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2196F3;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #1976D2;
        }
        button.success {
            background-color: #4CAF50;
        }
        button.success:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-indicator.online {
            background-color: #4CAF50;
        }
        .status-indicator.offline {
            background-color: #f44336;
        }
        .status-indicator.unknown {
            background-color: #FF9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Newport</h1>
        
        <div class="test-section">
            <h2>üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="text" id="userToCheck" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω">
            </div>
            <button onclick="checkUser()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            <div id="userCheckResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>‚úâÔ∏è –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
            <div class="form-group">
                <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="testUserId" placeholder="–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞">
            </div>
            <div class="form-group">
                <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                <input type="text" id="testTitle" value="–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">
            </div>
            <div class="form-group">
                <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                <textarea id="testMessage" rows="3">–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã</textarea>
            </div>
            <div class="form-group">
                <label>–¢–∏–ø:</label>
                <select id="testType">
                    <option value="system">–°–∏—Å—Ç–µ–º–Ω–æ–µ</option>
                    <option value="admin_response">–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</option>
                    <option value="service_update">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏</option>
                    <option value="news">–ù–æ–≤–æ—Å—Ç—å</option>
                </select>
            </div>
            <button onclick="createTestNotification()">–°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
            <div id="testNotificationResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üîç –ù–∞–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div class="form-group">
                <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="searchUserId" placeholder="–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω">
            </div>
            <button onclick="findUserNotifications()">–ù–∞–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <div id="searchResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üîî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FCM —Ç–æ–∫–µ–Ω—ã</h2>
            <div class="form-group">
                <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="fcmUserId" placeholder="–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞">
            </div>
            <button onclick="checkFCMTokens()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
            <div id="fcmResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
            <button onclick="getSystemStats()">–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <div id="statsResult" class="result" style="display: none;"></div>
        </div>

        <div class="loading" id="globalLoading">
            <div class="spinner"></div>
            <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBaZ2_2FbDOXjdFN_hBJFrqDLJwrKJfIo4",
            authDomain: "newport-23a19.firebaseapp.com",
            projectId: "newport-23a19",
            storageBucket: "newport-23a19.appspot.com",
            messagingSenderId: "346693260115",
            appId: "1:346693260115:web:b6b6b6b6b6b6b6b6b6b6b6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firebase = { doc, setDoc, getDoc, getDocs, query, where, orderBy, limit, collection };

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        function showLoading(show = true) {
            const loading = document.getElementById('globalLoading');
            loading.classList.toggle('show', show);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.checkUser = async function() {
            const userId = document.getElementById('userToCheck').value;
            if (!userId) {
                showResult('userCheckResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            showLoading(true);
            let result = `–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}\n\n`;

            try {
                const collections = ['users', 'residents', 'clients'];
                const searchFields = ['passport_number', 'passportNumber', 'phone', 'id'];
                let found = false;

                for (const collectionName of collections) {
                    result += `–ö–æ–ª–ª–µ–∫—Ü–∏—è ${collectionName}:\n`;
                    
                    // –ü–æ–∏—Å–∫ –ø–æ –ø—Ä—è–º–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
                    const directDoc = await firebase.getDoc(firebase.doc(db, collectionName, userId));
                    if (directDoc.exists()) {
                        result += `  ‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ ID: ${userId}\n`;
                        result += `  –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(directDoc.data(), null, 2)}\n\n`;
                        found = true;
                        continue;
                    }

                    // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—è–º
                    for (const field of searchFields) {
                        const q = firebase.query(
                            firebase.collection(db, collectionName),
                            firebase.where(field, '==', userId),
                            firebase.limit(1)
                        );
                        const snapshot = await firebase.getDocs(q);
                        
                        if (!snapshot.empty) {
                            result += `  ‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ –ø–æ–ª—é ${field}\n`;
                            snapshot.forEach(doc => {
                                result += `  ID: ${doc.id}\n`;
                                result += `  –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(doc.data(), null, 2)}\n`;
                            });
                            found = true;
                            break;
                        }
                    }

                    if (!found) {
                        result += `  ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω\n`;
                    }
                    result += '\n';
                }

                if (!found) {
                    result += '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏';
                }

                showResult('userCheckResult', result, found ? 'success' : 'error');
            } catch (error) {
                showResult('userCheckResult', `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        window.createTestNotification = async function() {
            const userId = document.getElementById('testUserId').value;
            const title = document.getElementById('testTitle').value;
            const message = document.getElementById('testMessage').value;
            const type = document.getElementById('testType').value;

            if (!userId || !title || !message) {
                showResult('testNotificationResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            showLoading(true);

            try {
                const notificationId = `test_${Date.now()}`;
                const notification = {
                    id: notificationId,
                    userId: userId,
                    title: title,
                    message: message,
                    type: type,
                    createdAt: new Date().toISOString(),
                    readAt: null,
                    isRead: false,
                    data: {},
                    relatedRequestId: null,
                    adminName: '–¢–µ—Å—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞',
                    imageUrl: null
                };

                await firebase.setDoc(firebase.doc(db, 'notifications', notificationId), notification);

                showResult('testNotificationResult', 
                    `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!\n\nID: ${notificationId}\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}\n–ó–∞–≥–æ–ª–æ–≤–æ–∫: ${title}\n–¢–∏–ø: ${type}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ`,
                    'success'
                );
            } catch (error) {
                showResult('testNotificationResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        // –ü–æ–∏—Å–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.findUserNotifications = async function() {
            const userId = document.getElementById('searchUserId').value;
            if (!userId) {
                showResult('searchResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            showLoading(true);
            let result = `–ü–æ–∏—Å–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}\n\n`;

            try {
                const identifiers = [userId];
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                if (userId.startsWith('+')) {
                    identifiers.push(userId.substring(1));
                } else if (userId.match(/^\d+$/)) {
                    identifiers.push('+' + userId);
                }

                result += `–ü–æ–∏—Å–∫ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º: ${identifiers.join(', ')}\n\n`;

                let totalFound = 0;
                for (const identifier of identifiers) {
                    const q = firebase.query(
                        firebase.collection(db, 'notifications'),
                        firebase.where('userId', '==', identifier),
                        firebase.orderBy('createdAt', 'desc'),
                        firebase.limit(10)
                    );

                    const snapshot = await firebase.getDocs(q);
                    
                    if (!snapshot.empty) {
                        result += `üì® –ù–∞–π–¥–µ–Ω–æ ${snapshot.size} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è "${identifier}":\n`;
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            result += `  ‚Ä¢ ${data.title} (${data.type})\n`;
                            result += `    –°–æ–∑–¥–∞–Ω–æ: ${data.createdAt}\n`;
                            result += `    –ü—Ä–æ—á–∏—Ç–∞–Ω–æ: ${data.isRead ? '–î–∞' : '–ù–µ—Ç'}\n\n`;
                            totalFound++;
                        });
                    }
                }

                if (totalFound === 0) {
                    result += '‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                } else {
                    result += `‚úÖ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: ${totalFound} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`;
                }

                showResult('searchResult', result, totalFound > 0 ? 'success' : 'error');
            } catch (error) {
                showResult('searchResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤
        window.checkFCMTokens = async function() {
            const userId = document.getElementById('fcmUserId').value;
            if (!userId) {
                showResult('fcmResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            showLoading(true);
            let result = `–ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}\n\n`;

            try {
                const collections = ['users', 'residents', 'clients'];
                let totalTokens = 0;

                for (const collectionName of collections) {
                    const userDoc = await firebase.getDoc(firebase.doc(db, collectionName, userId));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const fcmTokens = data.fcmTokens || [];
                        
                        result += `–ö–æ–ª–ª–µ–∫—Ü–∏—è ${collectionName}:\n`;
                        if (fcmTokens.length > 0) {
                            result += `  ‚úÖ –ù–∞–π–¥–µ–Ω–æ ${fcmTokens.length} —Ç–æ–∫–µ–Ω–æ–≤\n`;
                            fcmTokens.forEach((token, index) => {
                                result += `    ${index + 1}. ${token.substring(0, 20)}...\n`;
                            });
                            totalTokens += fcmTokens.length;
                        } else {
                            result += `  ‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤\n`;
                        }
                        result += '\n';
                    }
                }

                if (totalTokens === 0) {
                    result += '‚ùå FCM —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                } else {
                    result += `‚úÖ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: ${totalTokens} —Ç–æ–∫–µ–Ω–æ–≤`;
                }

                showResult('fcmResult', result, totalTokens > 0 ? 'success' : 'error');
            } catch (error) {
                showResult('fcmResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        window.getSystemStats = async function() {
            showLoading(true);
            let result = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n\n`;

            try {
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                const notificationsSnapshot = await firebase.getDocs(firebase.collection(db, 'notifications'));
                result += `üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:\n`;
                result += `  –í—Å–µ–≥–æ: ${notificationsSnapshot.size}\n`;
                
                const typeStats = {};
                const userStats = new Set();
                
                notificationsSnapshot.forEach(doc => {
                    const data = doc.data();
                    typeStats[data.type] = (typeStats[data.type] || 0) + 1;
                    userStats.add(data.userId);
                });
                
                result += `  –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${userStats.size}\n`;
                result += `  –ü–æ —Ç–∏–ø–∞–º:\n`;
                Object.entries(typeStats).forEach(([type, count]) => {
                    result += `    ${type}: ${count}\n`;
                });

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const collections = ['users', 'residents', 'clients'];
                result += `\nüë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n`;
                
                for (const collectionName of collections) {
                    const snapshot = await firebase.getDocs(firebase.collection(db, collectionName));
                    result += `  ${collectionName}: ${snapshot.size} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n`;
                }

                showResult('statsResult', result, 'info');
            } catch (error) {
                showResult('statsResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        console.log('–°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–æ—Ç–æ–≤–∞');
    </script>
</body>
</html> 