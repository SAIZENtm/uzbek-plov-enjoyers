rules_version = '2';

// üîê –ë–ï–ó–û–ü–ê–°–ù–´–ï –ü–†–ê–í–ò–õ–ê FIREBASE STORAGE –î–õ–Ø –ü–†–û–î–ê–ö–®–ù–ê
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç signInAnonymously)
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isAuthenticated() {
      // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö)
      return request.auth != null;
    }
    
    function isValidImage() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä –º–µ–Ω—å—à–µ 5MB
      return request.resource != null &&
             request.resource.contentType != null &&
             request.resource.contentType.matches('image/.*') &&
             request.resource.size < 5 * 1024 * 1024; // 5MB
    }
    
    function isValidFileSize() {
      // –û–±—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–¥–æ 10MB)
      return request.resource != null &&
             request.resource.size < 10 * 1024 * 1024; // 10MB
    }
    
    // üì± SERVICE REQUEST IMAGES
    // –ü—É—Ç—å: service_requests/{requestId}/images/{imageId}
    match /service_requests/{requestId}/images/{imageId} {
      // –†–∞–∑—Ä–µ—à–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ –∑–∞—è–≤–∫–∞–º
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated(); // –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    }
    
    // üë§ USER PROFILE IMAGES
    // –ü—É—Ç—å: users/{userId}/profile/{imageId}
    match /users/{userId}/profile/{imageId} {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üìä UTILITY READING IMAGES
    // –ü—É—Ç—å: utility_readings/{readingId}/images/{imageId}
    match /utility_readings/{readingId}/images/{imageId} {
      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üì∞ NEWS AND ADMIN CONTENT
    // –ü—É—Ç—å: admin/{allPaths=**}
    match /admin/{allPaths=**} {
      // –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      allow read: if true;
      // –ó–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
      allow write, delete: if isAuthenticated() && isValidFileSize();
    }
    
    // üìÅ TEMPORARY UPLOADS
    // –ü—É—Ç—å: temp/{userId}/{fileName}
    match /temp/{userId}/{fileName} {
      // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞)
      allow read, write: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }
    
    // üõ°Ô∏è DEFAULT DENY
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ - –∑–∞–ø—Ä–µ—â–µ–Ω–æ
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 